<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Mining App</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- jsQR Library for QR Code Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- qr-code-styling Library -->
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        :root {
            --bg-dark: #0F0F0F; --surface-color: #1C1C1E; --primary-green: #27C789; --text-negative: #FF453A; --text-primary: #FFFFFF; --text-secondary: #8E8E93; --primary-purple: #5126E5;
            --primary-red: #FF453A; --primary-orange: #FF9500; --primary-blue: #0A84FF;
        }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-primary); margin: 0; }
        .app-container { width: 100%; height: 100%; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .app-container::-webkit-scrollbar { display: none; }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* --- MODIFIED: Global Tap Highlight Removal --- */
        * { 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* --- NEW ANIMATED SPLASH SCREEN --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; display: flex; justify-content: center; align-items: center; z-index: 10002; transition: opacity 0.5s ease; }
        .splash-logo { position: absolute; max-width: 250px; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        #splash-logo1 { opacity: 0; transform: scale(0.8); }
        #splash-logo2 { opacity: 0; transform: scale(1.2); }
        #splash-logo1.visible { opacity: 1; transform: scale(1); }
        #splash-logo2.visible { opacity: 1; transform: scale(1); }
        
        /* --- NEW ANIMATED AUTH STYLES --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: #000; overflow: hidden; }
        .auth-bg-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .auth-bg-shape { position: absolute; list-style: none; display: block; background: rgba(255, 255, 255, 0.1); animation: animate-shapes 20s linear infinite; bottom: -150px; }
        .auth-bg-shape.shape1 { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .auth-bg-shape.shape2 { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .auth-bg-shape.shape3 { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .auth-bg-shape.shape4 { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .auth-bg-shape.shape5 { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .auth-bg-shape.shape6 { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .auth-bg-shape.shape7 { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .auth-bg-shape.shape8 { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .auth-bg-shape.shape9 { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .auth-bg-shape.shape10 { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }
        @keyframes animate-shapes { 0% { transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100% { transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }

        .auth-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        .auth-page.active { visibility: visible; transform: translateX(0); }
        .auth-page.inactive-left { transform: translateX(-100%); }
        .auth-page.inactive-right { transform: translateX(100%); }
        .auth-content { width: 100%; max-width: 340px; padding: 30px 25px; box-sizing: border-box; background: rgba(28, 28, 30, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .auth-page.active .auth-content h2 { animation: slideInUp 0.5s ease-out forwards; }
        .auth-page.active .auth-content .input-group { animation: slideInUp 0.5s ease-out forwards; }
        .auth-page.active .auth-content .input-group:nth-of-type(1) { animation-delay: 0.1s; }
        .auth-page.active .auth-content .input-group:nth-of-type(2) { animation-delay: 0.2s; }
        .auth-page.active .auth-content .input-group:nth-of-type(3) { animation-delay: 0.3s; }
        .auth-page.active .auth-content .input-group:nth-of-type(4) { animation-delay: 0.4s; }
        .auth-page.active .auth-content .auth-btn { animation: slideInUp 0.5s ease-out 0.5s forwards; }
        .auth-page.active .auth-content .toggle-link { animation: slideInUp 0.5s ease-out 0.6s forwards; }
        .auth-content h2, .auth-content .input-group, .auth-content .auth-btn, .auth-content .toggle-link { opacity: 0; }

        .auth-content h2 { font-size: 32px; font-weight: 700; text-align: center; margin-bottom: 30px; }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: var(--text-secondary); }
        .auth-input { width: 100%; padding: 14px 14px 14px 45px; background-color: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 12px; color: var(--text-primary); font-size: 16px; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        .auth-input:focus { outline: none; border-color: var(--primary-purple); box-shadow: 0 0 10px rgba(81, 38, 229, 0.5); }
        .auth-btn { width: 100%; padding: 15px; font-size: 18px; font-weight: 600; background: linear-gradient(90deg, var(--primary-green), var(--primary-purple)); border: none; border-radius: 12px; color: var(--text-primary); cursor: pointer; margin-top: 10px; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .auth-btn:hover { box-shadow: 0 5px 15px rgba(81, 38, 229, 0.4); transform: translateY(-2px); }
        .auth-btn:active { transform: scale(0.98) translateY(0); }
        .auth-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
        .toggle-link { text-align: center; margin-top: 20px; color: var(--text-secondary); }
        .toggle-link span { color: var(--primary-green); font-weight: 600; cursor: pointer; }
        .auth-error { color: var(--text-negative); text-align: center; font-size: 14px; min-height: 20px; }
        /* --- END OF NEW AUTH STYLES --- */
        
        /* GENERAL MODAL & REFERRAL POPUP STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .modal-content { background-color: var(--surface-color); padding: 30px; border-radius: 16px; text-align: center; max-width: 320px; width: 90%; box-sizing: border-box; border: 1px solid #333; animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); position: relative; }
        .modal-content i { font-size: 48px; color: var(--primary-green); margin-bottom: 15px; }
        .modal-content h3 { font-size: 22px; margin-bottom: 10px; }
        .modal-content p { color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; }
        .modal-btn { padding: 10px 20px; background-color: var(--primary-green); border: none; border-radius: 8px; font-weight: 600; color: #fff; cursor: pointer; }
        #referral-popup .modal-content img { width: 100%; max-width: 250px; border-radius: 12px; margin-bottom: 20px; }

        .main-content { padding-bottom: 120px; } /* Increased padding for new nav */

        /* --- NEW DASHBOARD STYLES --- */
        .new-wallet-header {
            padding: 16px; /* Modified for outer spacing */
        }
        /* NEW: Header Background Wrapper */
        .header-background {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--surface-color);
            border-radius: 24px;
            padding: 10px 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        .account-details { display: flex; align-items: center; gap: 12px; }
        .profile-pic { width: 48px; height: 48px; background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); }
        .profile-pic img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .account-details .user-info { display: flex; flex-direction: column; align-items: flex-start; }
        .user-name-wrapper { display: flex; align-items: center; gap: 8px; }
        .account-details h2 { font-size: 20px; font-weight: 700; margin: 0; }
        .blockchain-address { background: transparent; color: var(--text-secondary); font-size: 14px; padding: 0; border-radius: 0; margin-top: 4px; font-family: monospace; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .new-wallet-header .header-actions { display: flex; gap: 12px; }
        .new-wallet-header .header-btn {
            width: 44px; height: 44px; background: var(--surface-color); border: none; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-out; color: var(--text-primary);
        }
        .new-wallet-header .header-btn:hover { transform: translateY(-2px); background: #2c2c2e; }
        .new-wallet-header .header-btn i { font-size: 20px; }

        /* Wallet Card 3D Flip Container */
        .wallet-card-container {
            padding: 10px 16px;
            perspective: 1500px;
        }
        .wallet-card {
            position: relative;
            width: 100%;
            height: 220px;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .wallet-card.flipped { transform: rotateY(180deg); }
        .wallet-card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 24px;
            background: linear-gradient(135deg, #4d3f7e, #2c2a50);
            padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;
            color: #fff; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .wallet-card-back { transform: rotateY(180deg); }
        .wallet-card-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.8); }
        .wallet-title { display: flex; align-items: center; gap: 8px; }
        .wallet-title i { cursor: pointer; transition: transform 0.3s; font-size: 16px; }
        .wallet-title i:hover { transform: rotate(90deg); }
        .wallet-ref-id { font-family: monospace; font-weight: 600; color: rgba(255,255,255,0.6); }
        .wallet-card-balance { flex-grow: 1; display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
        .wallet-card-balance .balance-currency { font-size: 36px; font-weight: 600; align-self: flex-start; margin-top: 15px; color: rgba(255, 255, 255, 0.7); }
        .wallet-card-balance .balance-amount { font-size: 52px; font-weight: 700; letter-spacing: -1.5px; }
        .wallet-card-balance .balance-change { background-color: var(--primary-green); color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 14px; font-weight: 600; align-self: center; margin-left: 10px; }
        .wallet-card-balance.btc .balance-amount { font-size: 40px; }
        .wallet-card-balance.btc .balance-currency { font-size: 28px; align-self: center; margin-top: 0; }
        .wallet-card-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .wallet-action-btn { background-color: rgba(0, 0, 0, 0.25); border: none; border-radius: 12px; color: #fff; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .wallet-action-btn:hover { background-color: rgba(0, 0, 0, 0.4); }
        .wallet-action-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(0, 0, 0, 0.25); }
        .wallet-action-btn i { font-size: 20px; }
        .icon-scan { width: 24px; height: 24px; stroke: currentColor; }

        /* --- NEW DASHBOARD SECTIONS (QUICK TRANSFER & RECENT TX) --- */
        .dashboard-section {
            padding: 20px 16px 10px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .section-header .see-more {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .quick-transfer-list {
            display: flex;
            gap: 16px;
            align-items: center;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 10px;
        }
        .quick-transfer-list::-webkit-scrollbar { display: none; }
        .contact-bubble {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--surface-color);
            flex-shrink: 0;
        }
        .contact-bubble img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .add-contact-btn {
            width: 56px;
            height: 56px;
            flex-shrink: 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            border: 1px dashed var(--text-secondary);
        }
        .recent-tx-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .recent-tx-item {
            display: flex;
            align-items: center;
            gap: 16px;
            background-color: var(--surface-color);
            padding: 12px;
            border-radius: 16px;
        }
        .recent-tx-item .icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .recent-tx-item .icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .recent-tx-item .icon i { font-size: 20px; }
        .recent-tx-item .details {
            flex-grow: 1;
        }
        .recent-tx-item .details .title {
            font-size: 16px;
            font-weight: 600;
        }
        .recent-tx-item .details .date {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .recent-tx-item .amount {
            font-size: 16px;
            font-weight: 700;
            margin-left: auto;
        }
        .recent-tx-item .amount.positive { color: var(--primary-green); }
        .recent-tx-item .amount.negative { color: var(--text-negative); }
        
        /* NEW: Add Contact Modal Styles */
        .close-modal-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 20px; cursor: pointer;
        }
        #add-contact-step1, #add-contact-step2 { display: none; }
        #add-contact-step1.active, #add-contact-step2.active { display: block; }

        .add-contact-confirm-view { text-align: center; }
        .add-contact-confirm-view img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 12px; object-fit: cover; }
        .add-contact-confirm-view .name { font-size: 18px; font-weight: 600; margin: 0; }
        .add-contact-confirm-view .address { font-size: 12px; font-family: monospace; color: var(--text-secondary); word-break: break-all; margin-top: 4px; }
        #add-contact-modal .modal-footer { margin-top: 20px; display: flex; gap: 10px; }


        /* FREE MINER CLAIM BANNER */
        #claim-miner-banner { display: none; margin: 20px 16px 0; padding: 16px; background: linear-gradient(135deg, var(--primary-green), var(--primary-purple)); border-radius: 16px; text-align: center; box-shadow: 0 5px 20px rgba(81, 38, 229, 0.3); }
        #claim-miner-banner h3 { margin: 0 0 8px 0; }
        #claim-miner-banner p { margin: 0 0 16px 0; color: rgba(255,255,255,0.8); font-size: 14px; }
        #claim-miner-btn { background-color: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.5); padding: 10px 25px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        #dashboard-dynamic-content { padding: 20px 16px; }
        
        #profile-page { padding: 24px 16px; }
        .profile-header { text-align: center; margin-bottom: 30px; }
        #profile-page-name-wrapper { justify-content: center; }
        .verified-badge { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; }
        
        .profile-picture-wrapper { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        #profile-page-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--surface-color); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        #profile-pic-upload-label { position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background-color: var(--primary-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--bg-dark); }
        #profile-pic-upload-label i { color: #fff; }
        #profile-pic-input { display: none; }
        #profile-page-name { font-size: 24px; font-weight: 600; margin: 0; }
        #profile-page-email { font-size: 16px; color: var(--text-secondary); }
        .profile-section { margin-bottom: 25px; }
        .profile-section h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text-secondary); border-bottom: 1px solid #333; padding-bottom: 8px; }
        .profile-input-group { margin-bottom: 15px; }
        .profile-input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .profile-input { width: 100%; padding: 12px; background-color: var(--surface-color); border: 1px solid #333; border-radius: 8px; color: var(--text-primary); font-size: 16px; box-sizing: border-box; }
        .profile-info-text { word-wrap: break-word; font-family: monospace; font-size: 14px; background-color: var(--surface-color); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .profile-btn { width: 100%; padding: 12px; font-size: 16px; font-weight: 600; background-color: var(--primary-green); border: none; border-radius: 8px; color: #fff; cursor: pointer; }
        .verification-card { background-color: var(--surface-color); border: 1px solid #333; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; }
        .verification-card .icon-wrapper { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .verification-card .icon-wrapper i { font-size: 20px; color: #fff; }
        .verification-card .info { flex-grow: 1; }
        .verification-card .info .status-title { font-size: 16px; font-weight: 600; margin: 0 0 4px 0; }
        .verification-card .info .description { font-size: 14px; color: var(--text-secondary); margin: 0; }
        .verification-card .action-btn { padding: 8px 16px; font-size: 14px; font-weight: 600; background-color: var(--primary-purple); border: none; border-radius: 8px; color: #fff; cursor: pointer; white-space: nowrap; }
        .verification-card.verified .icon-wrapper { background-color: rgba(39, 199, 137, 0.2); }
        .verification-card.verified .icon-wrapper i { color: var(--primary-green); }
        .verification-card.verified .info .status-title { color: var(--primary-green); }
        .verification-card.not-verified .icon-wrapper { background-color: rgba(255, 69, 58, 0.2); }
        .verification-card.not-verified .icon-wrapper i { color: var(--text-negative); }
        .verification-card.not-verified .info .status-title { color: var(--text-negative); }
        #logout-btn { width: 100%; padding: 15px; margin-top: 30px; font-size: 16px; font-weight: 600; background-color: transparent; border: 1px solid var(--text-negative); border-radius: 12px; color: var(--text-negative); cursor: pointer; }
        #booster-page { padding: 24px 16px; }
        .gauge-wrapper { width: 350px; height: 350px; margin: 20px auto 40px; position: relative; display: flex; justify-content: center; align-items: center; }
        /* MODIFIED Gauge progress animation */
        .gauge-progress { width: 100%; height: 100%; border-radius: 50%; position: absolute; transition: background 0.5s linear; -webkit-mask-image: radial-gradient(transparent 65%, black 66%); mask-image: radial-gradient(transparent 65%, black 66%); }
        .gauge-scale { width: 100%; height: 100%; position: absolute; }
        .gauge-tick-segment { position: absolute; top: 50%; left: 50%; width: 15px; height: 28px; background-color: #3A3A3C; border-radius: 8px; transform-origin: center; }
        .gauge-label { position: absolute; color: var(--text-secondary); font-size: 12px; font-weight: 500; }
        .gauge-center-content { display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 10; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); }
        .gauge-value-box { background-color: #1c1c1e; padding: 8px 24px; border-radius: 50px; font-size: 36px; font-weight: 700; color: #fff; border: 1px solid #333; box-shadow: inset 0 2px 4px rgba(0,0,0,0.6), 0 2px 2px rgba(255,255,255,0.1); }
        .gauge-value-box span:last-child { color: var(--primary-green); }
        .hash-rate { text-align: center; }
        .hash-rate .value { font-size: 26px; font-weight: 600; color: var(--primary-green); }
        .hash-rate .label { font-size: 15px; color: var(--text-secondary); }
        .section-title { font-size: 22px; font-weight: 700; margin-top: 40px; margin-bottom: 16px; }
        .booster-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .booster-card { background-color: var(--surface-color); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 12px; border: 1px solid #2d2d2f; }
        .booster-card .icon-wrapper { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .booster-card .icon-wrapper i { font-size: 20px; color: #fff; }
        .booster-card.active .icon-wrapper { background-color: rgba(39, 199, 137, 0.2); box-shadow: 0 0 15px rgba(39, 199, 137, 0.3); }
        .booster-card.inactive .icon-wrapper { background-color: rgba(255, 165, 0, 0.2); box-shadow: 0 0 15px rgba(255, 165, 0, 0.3); }
        .booster-info .status { font-size: 16px; font-weight: 600; }
        .booster-info .devices { font-size: 14px; color: var(--text-secondary); }
        .booster-card.active .status { color: var(--primary-green); }
        .booster-card.inactive .status { color: var(--primary-orange); }
        .booster-card.online .icon-wrapper { background: linear-gradient(45deg, #28a745, #20c997); box-shadow: 0 0 15px rgba(40, 167, 69, 0.5); }
        .booster-card.online .status { color: #28a745; }
        .booster-card.offline .icon-wrapper { background: linear-gradient(45deg, #6c757d, #343a40); box-shadow: 0 0 15px rgba(108, 117, 125, 0.4); }
        .booster-card.offline .status { color: #6c757d; }
        /* MODIFIED Manage Miners Button */
        #manage-miners-btn {
            width: 100%;
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid #2d2d2f;
            font-size: 16px;
            font-weight: 600;
            margin-top: 24px;
            border-radius: 16px;
            padding: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease-out;
        }
        #manage-miners-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-color: var(--primary-green);
        }
        /* MODIFIED Rewards Section */
        .rewards-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .reward-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #2d2d2f;
            border-left: 4px solid var(--primary-orange);
            border-right: 4px solid var(--primary-green);
        }
        .reward-card::before {
           content: none; /* Removed top border */
        }
        .reward-card .title { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .reward-card .amount-btc { font-size: 20px; font-weight: 700; color: var(--primary-orange); }
        .reward-card .amount-btc span { font-size: 14px; font-weight: 500; }
        .reward-card .amount-usd { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        #history-page { padding: 16px; box-sizing: border-box; }
        .page-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 0 16px; }
        .page-header .header-btn { background-color: var(--surface-color); }
        .page-header h2 { font-size: 22px; font-weight: 700; margin: 0; }
        #transaction-list { display: flex; flex-direction: column; gap: 12px; }
        .transaction-item { display: flex; align-items: center; gap: 16px; background-color: var(--surface-color); border-radius: 16px; padding: 16px; border: 1px solid #2d2d2f; opacity: 0; transform: translateY(20px); animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        /* --- MODIFIED HISTORY ICONS --- */
        .transaction-item .icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .transaction-item .icon i { font-size: 24px; }
        .transaction-item .details { flex-grow: 1; }
        .transaction-item .details .title { font-size: 16px; font-weight: 600; margin: 0 0 4px 0; }
        .transaction-item .details .date { font-size: 13px; color: var(--text-secondary); }
        .transaction-item .amount { text-align: right; }
        .transaction-item .amount-btc { font-size: 16px; font-weight: 700; }
        .transaction-item .amount-usd { font-size: 13px; color: var(--text-secondary); }
        .transaction-item.sent .icon { background-color: rgba(255, 69, 58, 0.15); }
        .transaction-item.sent .icon i { color: var(--text-negative); }
        .transaction-item.sent .amount-btc { color: var(--text-primary); }
        .transaction-item.received .icon { background-color: rgba(39, 199, 137, 0.15); }
        .transaction-item.received .icon i { color: var(--primary-green); }
        .transaction-item.received .amount-btc { color: var(--primary-green); }
        .transaction-item.deposit .icon { background-color: rgba(10, 132, 255, 0.15); }
        .transaction-item.deposit .icon i { color: var(--primary-blue); }
        .transaction-item.deposit .amount-btc { color: var(--primary-blue); }
        .transaction-item.withdraw .icon { background-color: rgba(255, 149, 0, 0.15); }
        .transaction-item.withdraw .icon i { color: var(--primary-orange); }
        .transaction-item.withdraw .amount-btc { color: var(--text-primary); }
        .transaction-item.purchase .icon { background-color: rgba(81, 38, 229, 0.15); }
        .transaction-item.purchase .icon i { color: var(--primary-purple); }
        .transaction-item.purchase .amount-btc { color: var(--text-primary); }
        .transaction-item.mining .icon { background-color: rgba(39, 199, 137, 0.15); } 
        .transaction-item.mining .icon i { color: var(--primary-green); }
        .transaction-item.mining .amount-btc { color: var(--primary-green); }
        .transaction-item.upgrade .icon { background-color: rgba(81, 38, 229, 0.15); } 
        .transaction-item.upgrade .icon i { color: var(--primary-purple); }
        .transaction-item.upgrade .amount-btc { color: var(--text-primary); }

        #no-transactions-message { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        #no-transactions-message i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        #no-transactions-message p { font-size: 16px; font-weight: 500; }
        
        /* --- NEW LEVEL DETAILS PAGE --- */
        #level-details-page { padding-bottom: 20px; box-sizing: border-box; }
        #level-details-page .search-bar-wrapper { padding: 0 16px 16px; }
        .search-input-group { position: relative; }
        .search-input-group i { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: var(--text-secondary); }
        #level-user-search { width: 100%; padding: 12px 12px 12px 40px; background-color: var(--surface-color); border: 1px solid #333; border-radius: 12px; color: var(--text-primary); font-size: 16px; box-sizing: border-box; }
        #level-user-list { display: flex; flex-direction: column; gap: 12px; padding: 0 16px; }
        .level-user-item { display: flex; align-items: center; gap: 12px; background-color: var(--surface-color); border-radius: 12px; padding: 12px; border: 1px solid #2d2d2f; }
        .level-user-item img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .level-user-item .info { flex-grow: 1; }
        .level-user-item .info .name { font-size: 16px; font-weight: 600; margin: 0; }
        .level-user-item .info .uid { font-size: 12px; color: var(--text-secondary); font-family: monospace; }
        #no-level-users-message { text-align: center; padding: 80px 20px; color: var(--text-secondary); }


        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(30px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        #receive-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(160deg, #5126E5 0%, #1a0a4c 100%); z-index: 1001; display: none; flex-direction: column; box-sizing: border-box; }
        .receive-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 30px; padding: 20px; }
        .qr-code-container { background-color: #fff; padding: 20px; border-radius: 32px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        #qr-code-canvas { display: block; width: 250px !important; height: 250px !important; }
        .receive-address-wrapper { width: 100%; max-width: 320px; text-align: center; opacity: 0; animation: slideUp 0.5s ease-out 0.2s forwards; }
        .receive-address-wrapper p { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 12px; font-weight: 500; }
        .receive-address-box { display: flex; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.2); padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.2); }
        .receive-address-box span { font-family: monospace; font-size: 14px; color: #fff; word-break: break-all; text-align: left; flex-grow: 1; }
        .receive-address-box button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; padding: 5px; }


        .flow-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1001; display: none; flex-direction: column; box-sizing: border-box; }
        .flow-step { display: none; flex-direction: column; height: 100%; width: 100%; animation: fadeIn 0.3s ease; }
        .flow-step.active { display: flex; }
        .flow-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; flex-shrink: 0; }
        .flow-header h2 { font-size: 18px; font-weight: 600; margin: 0; }
        .flow-header .header-btn { background: none; border: none; color: #fff; font-size: 16px; cursor: pointer; font-weight: 600; padding: 8px; }
        .flow-header .header-btn i { font-size: 20px; }
        #address-error-msg { color: var(--text-negative); font-size: 14px; margin-top: 8px; min-height: 20px; }
        #limit-error-msg { color: var(--primary-orange); font-size: 14px; margin-top: 8px; min-height: 20px; text-align: center; }
        .amount-input-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; padding: 10px 24px; width: 100%; box-sizing: border-box; cursor: text; }
        .amount-display-wrapper { display: flex; align-items: center; gap: 4px; }
        #send-amount-display { font-size: 64px; font-weight: 700; margin: 0; min-height: 76px; }
        #send-amount-display.placeholder { color: var(--text-secondary); }
        .cursor { display: none; width: 3px; height: 60px; background-color: var(--primary-green); animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #send-currency-unit { font-size: 28px; font-weight: 600; color: var(--text-secondary); }
        .currency-toggle-btn { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; transition: transform 0.3s ease; padding: 10px; }
        #send-amount-equivalent { font-size: 18px; color: var(--text-secondary); margin: 8px 0 0 0; }
        .address-input-wrapper { position: relative; width: 100%; }
        #recipient-address-input { padding-right: 85px; transition: all 0.3s ease; }
        #recipient-address-input.scanned { background-color: #2a2a2e; border-color: var(--primary-green); box-shadow: 0 0 10px rgba(39, 199, 137, 0.4); cursor: not-allowed; }
        .qr-scan-btn-inline { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
        
        /* New Recipient Info Display */
        #recipient-info-display {
            display: none; /* Initially hidden */
            background-color: var(--surface-color);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            align-items: center;
            gap: 12px;
        }
        #recipient-info-display img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        #recipient-info-details { flex-grow: 1; }
        #recipient-info-name { font-weight: 600; font-size: 16px; margin: 0; }
        #recipient-info-address { font-family: monospace; font-size: 12px; color: var(--text-secondary); margin: 2px 0 0 0; }
        #clear-scanned-address-btn { background: none; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; padding: 5px; }

        
        .flow-footer { background-color: #121212; padding: 12px 24px 24px 24px; flex-shrink: 0; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #2d2d2f; }
        .available-balance-row { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 14px; }
        #send-max-btn { background-color: #333; color: #fff; border: none; padding: 6px 14px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .flow-next-btn { background: linear-gradient(90deg, var(--primary-red), var(--primary-orange)); color: #fff; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .flow-next-btn:active { transform: scale(0.98); }
        .flow-next-btn:disabled { background: #2c2c2e; color: #888; box-shadow: none; cursor: not-allowed; }

        .confirmation-summary { padding: 24px; flex-grow: 1; width: 100%; box-sizing: border-box; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #2d2d2f; }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { color: var(--text-secondary); }
        .summary-value { font-weight: 600; text-align: right; }
        .summary-value .value-secondary { display: block; font-size: 14px; color: var(--text-secondary); font-weight: 400; }
        
        #confirmation-footer { padding: 24px; margin-top: auto; }
        .swipe-container { width: 100%; background-color: rgba(255, 255, 255, 0.05); border-radius: 50px; padding: 8px; position: relative; overflow: hidden; text-align: center; border: 1px solid #444; box-sizing: border-box; height: 64px; display: flex; align-items: center; justify-content: center; }
        .swipe-text { color: var(--text-secondary); font-weight: 600; font-size: 16px; z-index: 1; position: relative; transition: opacity 0.2s; letter-spacing: 0.5px; }
        .swipe-thumb { position: absolute; top: 8px; left: 8px; width: 48px; height: 48px; background: linear-gradient(45deg, var(--primary-green), #2db580); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: grab; z-index: 2; box-shadow: 0 4px 20px rgba(39, 199, 137, 0.5); transition: transform 0.1s linear; }
        .swipe-thumb:active { cursor: grabbing; }
        .swipe-thumb i { color: #fff; font-size: 20px; transition: transform 0.3s ease; }
        .swipe-thumb.swiping i { transform: scale(1.2); }
        .swipe-track-fill { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--primary-green); opacity: 0.3; border-radius: 50px; width: 64px; }
        
        .flow-success-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; overflow: hidden; position: relative; }
        .btc-animation-icon { position: absolute; font-size: 60px; color: #f7931a; will-change: transform; opacity: 0; }
        .success-main-content { z-index: 2; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) 0.5s forwards; opacity: 0; }
        .success-main-content h2 { font-size: 28px; margin-bottom: 10px; }
        .success-main-content p { color: var(--text-secondary); margin-bottom: 25px; }
        .success-details { background-color: var(--surface-color); border-radius: 12px; padding: 16px; width: 100%; max-width: 350px; }
        @keyframes send-btc-animation { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 20% { opacity: 1; } 100% { transform: translate(150px, -400px) scale(0.5) rotate(720deg); opacity: 0; } }

        .fund-flow-content { flex-grow: 1; overflow-y: auto; padding: 16px 24px 20px 24px; }
        .fund-card { background-color: var(--surface-color); border-radius: 16px; padding: 24px; border: 1px solid #2d2d2f; margin-bottom: 16px; }
        .fund-card .profile-input-group { opacity: 0; animation: slideUp 0.5s ease-out forwards; }
        .fund-card .profile-input-group:nth-child(2) { animation-delay: 0.1s; }
        .fund-card .profile-input-group:nth-child(3) { animation-delay: 0.2s; }
        .deposit-address-container { text-align: center; padding: 20px; }
        .deposit-address-container img { max-width: 180px; border-radius: 12px; margin-bottom: 15px; }
        .deposit-address-box { display: flex; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; border: 1px solid #444; }
        .deposit-address-box span { font-family: monospace; font-size: 14px; color: #fff; word-break: break-all; text-align: left; flex-grow: 1; }
        .file-upload-label { display: inline-block; background-color: #2a2a2e; padding: 12px 20px; border-radius: 8px; border: 1px dashed #555; cursor: pointer; transition: background-color 0.2s; }
        .file-upload-label:hover { background-color: #3a3a3c; }
        #screenshot-file-name { color: var(--text-secondary); font-size: 12px; margin-top: 8px; display: block; }
        
        #fund-choice-step .fund-flow-content { display: flex; flex-direction: column; justify-content: center; gap: 20px; }
        .fund-choice-card {
            background: linear-gradient(135deg, #1e1e20, #2a2a2e);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            animation: slideUp 0.6s ease-out forwards;
        }
        #fund-choice-step .fund-choice-card:nth-child(2) { animation-delay: 0.15s; }
        .fund-choice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border-color: var(--primary-green);
        }
        .fund-choice-card:active { transform: scale(0.98); }
        .fund-choice-card .icon-wrapper {
            width: 50px; height: 50px;
            border-radius: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        .fund-choice-card .info h3 { margin: 0 0 5px 0; font-size: 18px; font-weight: 600; }
        .fund-choice-card .info p { margin: 0; font-size: 14px; color: var(--text-secondary); }
        #go-to-deposit-btn .icon-wrapper { background: linear-gradient(45deg, var(--primary-blue), #3b8aff); }
        #go-to-withdraw-btn .icon-wrapper { background: linear-gradient(45deg, var(--primary-orange), #ffae40); }

        .status-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .status-icon-wrapper { width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; margin-bottom: 24px; animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .status-icon-wrapper i { font-size: 50px; }
        #fund-pending-icon { color: var(--primary-orange); }
        #fund-success-icon { color: var(--primary-green); }
        .status-content h2 { font-size: 28px; margin-bottom: 10px; animation: slideUp 0.5s ease-out 0.2s forwards; opacity: 0;}
        .status-content p { color: var(--text-secondary); margin-bottom: 25px; animation: slideUp 0.5s ease-out 0.3s forwards; opacity: 0; max-width: 300px; }

        /* --- NEW 3D NAVIGATION BAR --- */
        .new-bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 400px;
            height: 70px;
            background-color: #2C2C2E;
            border-radius: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 1000;
        }
        .nav-items-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .new-nav-item {
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .nav-icon-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .new-nav-item i, .nav-center-button i {
            font-size: 22px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .new-nav-item.active .nav-icon-wrapper {
            background-color: var(--primary-green);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(39, 199, 137, 0.4);
        }
        .new-nav-item.active i {
            color: #fff;
        }
        .nav-center-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 64px;
            height: 64px;
            background: linear-gradient(45deg, var(--primary-green), #34e79a);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(39, 199, 137, 0.5);
            border: 4px solid var(--bg-dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-center-button:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        .nav-center-button i {
            font-size: 28px;
            color: #fff;
        }
        .nav-center-button.active {
             box-shadow: 0 0 0 4px var(--bg-dark), 0 0 0 7px var(--primary-green);
        }
        .nav-placeholder {
            width: 64px;
            height: 64px;
            flex-shrink: 0;
        }


        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #444; border-top: 5px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .qr-scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 10001; gap: 20px; }
        #qr-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .scanner-box { width: 250px; height: 250px; border: 2px solid rgba(255, 255, 255, 0.7); position: relative; overflow: hidden; border-radius: 16px; z-index: 2; background: rgba(0,0,0,0.1); }
        .scanner-line { position: absolute; left: 0; width: 100%; height: 2px; background: var(--primary-green); box-shadow: 0 0 10px var(--primary-green); animation: scan-anim 2s infinite linear; }
        @keyframes scan-anim { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .scanner-content { z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 20px; position: relative; }
        .close-scanner-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; z-index: 3; }
        .close-scanner-btn i { font-size: 22px; color: #fff; }
        #permission-message { color: white; font-size: 16px; padding: 10px 20px; background: rgba(217, 30, 24, 0.7); border-radius: 8px; max-width: 80%; text-align: center; }
        .scanner-upload-label { background-color: var(--surface-color); color: var(--text-primary); padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; border: 1px solid #333; }
        #qr-file-input { display: none; }
        
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--surface-color); color: var(--text-primary); padding: 14px 22px; border-radius: 12px; font-weight: 600; z-index: 10003; border-left: 5px solid var(--primary-green); box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast-notification.show { bottom: 100px; }
        .toast-notification.error { border-left-color: var(--text-negative); }

        /* --- NEW PROFESSIONAL MARKET STYLES (from reference) --- */
        .market-content { padding: 16px; display: flex; flex-direction: column; gap: 16px; background-color: #000; }
        .market-list-item {
            background: #fff;
            color: #000;
            border-radius: 20px;
            padding: 12px;
            display: flex;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
            transition: transform 0.2s ease-out;
        }
        .market-list-item:active {
            transform: scale(0.98);
        }
        .product-image-wrapper-new {
            width: 120px;
            height: 120px;
            flex-shrink: 0;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }
        .product-image-wrapper-new img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .product-details-wrapper-new {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            position: relative;
        }
        .product-details-wrapper-new h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 900;
        }
        .product-details-wrapper-new .version-code {
            margin: 2px 0 4px 0;
            font-size: 12px;
            color: #555;
        }
        .product-details-wrapper-new .description {
            margin: 0;
            font-size: 14px;
            color: #333;
            flex-grow: 1;
        }
        .stock-display {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 12px;
            font-weight: 700;
            color: #444;
        }
        .price-wrapper-new {
            position: absolute;
            bottom: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .discount-off-text {
            color: #FF6347;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 2px;
        }
        .price-tag {
            background: #000;
            border-radius: 12px;
            padding: 6px 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .final-price-green {
            color: var(--primary-green);
            font-weight: 800;
            font-size: 18px;
        }
        .original-price-struck {
            color: var(--text-negative);
            text-decoration: line-through;
            font-size: 14px;
            font-weight: 600;
        }


        /* MODIFIED MY MINERS PAGE STYLES (MATCHES STORE) */
        #my-miners-page { padding: 16px; background-color: #000; }
        .my-miner-list { display: flex; flex-direction: column; gap: 12px; }
        .my-miner-card-new {
            background: #fff; color: #000; border-radius: 20px; padding: 12px;
            display: grid; grid-template-columns: 120px 1fr; gap: 12px;
            align-items: center;
        }
        .my-miner-card-new .info {
            display: flex; flex-direction: column; gap: 4px;
        }
        .my-miner-card-new .info h4 { margin: 0; font-size: 18px; font-weight: 900; }
        .my-miner-card-new .info .quantity { font-size: 14px; font-weight: 700; color: var(--primary-purple); }
        .my-miner-card-new .info .stat { font-size: 13px; color: #555; }
        .my-miner-card-new .upgrade-btn {
            grid-column: 1 / -1; /* Span full width */
            background: linear-gradient(90deg, var(--primary-purple), #8162ff);
            color: #fff; border: none; padding: 12px; border-radius: 12px; margin-top: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .my-miner-card-new .upgrade-btn:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(81, 38, 229, 0.4); }
        .my-miner-card-new .upgrade-btn:disabled { background: #ccc; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }
        
        
        /* NEW UPGRADE FLOW STYLES */
        .upgrade-flow-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            flex-grow: 1;
            justify-content: center;
            background-color: #000;
        }
        .upgrade-card-wrapper { width: 100%; }
        .upgrade-card-wrapper .label {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .upgrade-card-wrapper .market-list-item {
            cursor: default;
        }
         .upgrade-card-wrapper .market-list-item:active {
            transform: none;
        }
        .upgrade-arrow {
            font-size: 32px;
            color: var(--primary-green);
            transform: rotate(90deg);
        }
        #upgrade-cost-summary {
            text-align: center;
            margin-top: 20px;
        }
        #upgrade-cost-summary .label {
            color: var(--text-secondary);
        }
        #upgrade-cost { font-size: 32px; font-weight: 700; color: var(--primary-green); }


        /* --- Community Page Styles --- */
        #community-apply-view { text-align: center; padding: 60px 20px; }
        .apply-community-card { background: linear-gradient(145deg, rgba(28, 28, 30, 0.7), rgba(44, 44, 46, 0.7)); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .apply-community-card i { font-size: 48px; color: var(--primary-green); margin-bottom: 20px; }
        .apply-community-card h2 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .apply-community-card p { color: var(--text-secondary); margin-bottom: 30px; }
        .apply-community-btn { padding: 15px 30px; font-size: 18px; }
        .commission-balance-card { background: linear-gradient(135deg, var(--primary-purple), #3a1a9e); border-radius: 20px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 25px rgba(81, 38, 229, 0.3); margin-bottom: 20px; }
        .commission-balance-card .balance-info .label { display: block; font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
        .commission-balance-card .balance-info .amount-usd { font-size: 28px; font-weight: 800; color: #fff; }
        .commission-balance-card .swap-btn { background-color: rgba(255,255,255,0.2); border: none; border-radius: 12px; color: #fff; padding: 12px 16px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s ease; }
        .commission-balance-card .swap-btn:hover { background-color: rgba(255,255,255,0.3); }
        .referral-code-card { background-color: var(--surface-color); border-radius: 16px; padding: 16px; margin-bottom: 24px; border: 1px solid #333; }
        .referral-code-card .label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }
        .referral-code-card .code-box { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-dark); border-radius: 10px; padding: 12px; }
        .referral-code-card #referral-code-text { font-family: monospace; font-size: 18px; font-weight: 700; color: var(--primary-green); }
        .referral-code-card .copy-btn { background: none; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; }
        .levels-list { display: flex; flex-direction: column; gap: 12px; }
        .level-card { background: var(--surface-color); border-radius: 16px; border-left: 4px solid var(--primary-blue); padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .level-card:hover { transform: translateX(4px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
        .level-card:nth-child(1) { border-left-color: #FFD700; }
        .level-card:nth-child(2) { border-left-color: #C0C0C0; }
        .level-card:nth-child(3) { border-left-color: #CD7F32; }
        .level-card .level-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .level-header h4 { margin: 0; font-size: 16px; font-weight: 600; }
        .level-header .commission-rate { font-size: 12px; font-weight: 500; color: #fff; background-color: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 20px; }
        .level-card .level-stats { display: flex; justify-content: space-around; align-items: center; }
        .level-stats .stat-item { text-align: center; }
        .stat-item .label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-item .value { font-size: 16px; font-weight: 700; }

        /* --- PRODUCT PURCHASE FLOW STYLES --- */
        .product-details-content { padding: 16px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        #product-details-image { width: 100%; max-width: 250px; margin: 20px auto; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #product-details-name { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 10px; }
        #product-details-description { font-size: 14px; color: var(--text-secondary); text-align: center; line-height: 1.6; margin-bottom: 24px; flex-grow: 1; }
        .quantity-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .quantity-btn { width: 44px; height: 44px; border: 1px solid #444; background-color: var(--surface-color); color: #fff; font-size: 24px; border-radius: 50%; cursor: pointer; }
        #product-quantity { font-size: 28px; font-weight: 600; min-width: 40px; text-align: center; }
        .price-details { text-align: center; margin-bottom: 20px; }
        #product-original-price { text-decoration: line-through; color: var(--text-secondary); font-size: 16px; }
        #product-discounted-price { font-size: 32px; font-weight: 700; color: var(--primary-green); }

    </style>
</head>
<body>
    <div id="toast-notification" class="toast-notification"></div>
    <div id="splash-screen">
        <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/31b098de3ca86934523e346c6c585c8f.jpg?alt=media&token=556d831a-d4a1-4306-bf1e-21e5f2da60f1" class="splash-logo" id="splash-logo1" alt="Logo">
        <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/c7dccee6ad1b0e20cf19cdfb231a7c39.jpg?alt=media&token=864540d0-00be-46d9-908b-89c5edc56462" class="splash-logo" id="splash-logo2" alt="Logo Alt">
    </div>
    
    <div id="auth-overlay" style="display: none;">
        <div class="auth-bg-shapes">
            <div class="auth-bg-shape shape1"></div><div class="auth-bg-shape shape2"></div><div class="auth-bg-shape shape3"></div>
            <div class="auth-bg-shape shape4"></div><div class="auth-bg-shape shape5"></div><div class="auth-bg-shape shape6"></div>
            <div class="auth-bg-shape shape7"></div><div class="auth-bg-shape shape8"></div><div class="auth-bg-shape shape9"></div><div class="auth-bg-shape shape10"></div>
        </div>
        <div id="auth-login-page" class="auth-page">
            <div class="auth-content">
                <h2>Welcome Back</h2>
                <p class="auth-error" id="login-error"></p>
                <form id="login-form-fields">
                    <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="login-email" class="auth-input" placeholder="Email" required></div>
                    <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="login-password" class="auth-input" placeholder="Password" required></div>
                    <button type="submit" class="auth-btn" id="login-btn">Login</button>
                </form>
                <p class="toggle-link">Don't have an account? <span id="show-register">Register</span></p>
            </div>
        </div>
        <div id="auth-register-page" class="auth-page">
            <div class="auth-content">
                <h2>Create Account</h2>
                <p class="auth-error" id="register-error"></p>
                <form id="register-form-fields">
                    <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="register-name" class="auth-input" placeholder="Full Name" required></div>
                    <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="register-email" class="auth-input" placeholder="Email" required></div>
                    <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="register-password" class="auth-input" placeholder="Password (min. 6 characters)" required></div>
                    <div class="input-group"><i class="fa-solid fa-user-group"></i><input type="text" id="register-referral-code" class="auth-input" placeholder="Referral Code (Optional)"></div>
                    <button type="submit" class="auth-btn" id="register-btn">Register</button>
                </form>
                <p class="toggle-link">Already have an account? <span id="show-login">Login</span></p>
            </div>
        </div>
    </div>
    <!-- NEW REFERRAL POPUP -->
    <div id="referral-popup" class="modal-overlay">
        <div class="modal-content">
            <img src="https://gomining.ghost.io/content/images/2025/08/cover_27-4.webp" alt="Referral Bonus">
            <h3>Get a FREE Miner!</h3>
            <p>
                Did you know? By using a friend's referral code when you sign up, you'll receive a free BTC mining machine to kickstart your earnings! This special gift allows you to start mining and earning rewards immediately, at no cost. Don't miss out on this exclusive opportunity to boost your mining journey from day one.
            </p>
            <button id="close-referral-popup" class="modal-btn">Got it!</button>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <i class="fa-solid fa-check"></i>
            <h3>Registration Successful!</h3>
            <p>Logging you in automatically...</p>
        </div>
    </div>
    
    <!-- NEW: Add Contact Modal -->
    <div id="add-contact-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn" id="close-contact-modal-btn"><i class="fa-solid fa-xmark"></i></button>
            <!-- Step 1: Enter Address -->
            <div id="add-contact-step1" class="active">
                <h3>Add Quick Contact</h3>
                <p>Enter the user's BTC address to add them to your quick transfer list.</p>
                <div class="profile-input-group" style="margin-bottom: 10px;">
                    <input type="text" id="add-contact-address-input" class="profile-input" placeholder="Enter BTC Address">
                </div>
                <button id="add-contact-next-btn" class="modal-btn" style="width: 100%;">Next</button>
            </div>
            <!-- Step 2: Confirm User -->
            <div id="add-contact-step2">
                 <h3>Confirm User</h3>
                 <div class="add-contact-confirm-view">
                    <img id="confirm-contact-pic" src="" alt="User">
                    <h4 id="confirm-contact-name" class="name"></h4>
                    <p id="confirm-contact-address" class="address"></p>
                 </div>
                 <div id="add-contact-swipe-container" class="swipe-container" style="margin-top: 20px;">
                    <div class="swipe-track-fill" id="add-contact-swipe-track-fill"></div>
                    <div class="swipe-thumb" id="add-contact-swipe-thumb"><i class="fa-solid fa-check"></i></div>
                    <span class="swipe-text" id="add-contact-swipe-text">Swipe to Add</span>
                </div>
                <button id="add-contact-back-btn" class="modal-btn" style="background: var(--surface-color); border: 1px solid var(--text-secondary); margin-top: 10px; width: 100%;">Back</button>
            </div>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <main class="main-content">
            <div id="dashboard-page" class="page">
                <header class="new-wallet-header">
                    <div class="header-background">
                        <div class="account-info">
                            <div class="account-details">
                                <div class="profile-pic" id="profile-pic-btn">
                                    <img id="user-profile-pic" src="" alt="P">
                                </div>
                                <div class="user-info">
                                    <div class="user-name-wrapper">
                                        <h2 id="user-display-name">User</h2>
                                        <span id="dashboard-verified-icon" class="verified-badge"></span>
                                    </div>
                                    <div class="blockchain-address" id="dashboard-address-container">
                                        <span id="dashboard-short-address"></span>
                                        <i id="copy-icon" class="fa-solid fa-copy"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="header-btn" id="qr-scan-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-scan" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                            </button>
                            <button class="header-btn" id="refresh-btn"><i class="fa-solid fa-arrows-rotate"></i></button>
                        </div>
                    </div>
                </header>

                <div class="wallet-card-container">
                    <div class="wallet-card">
                        <!-- Front Side (USDT) -->
                        <div class="wallet-card-face wallet-card-front">
                            <div class="wallet-card-header">
                                <span class="wallet-title">My Wallet (USDT) <i id="currency-switch-btn" class="fa-solid fa-rotate"></i></span>
                                <span class="wallet-ref-id" id="wallet-ref-id">****</span>
                            </div>
                            <div class="wallet-card-balance">
                                <span class="balance-currency">$</span>
                                <span class="balance-amount" id="balance-usdt">0.00</span>
                                <span class="balance-change" id="balance-change-usdt">+0%</span>
                            </div>
                            <div class="wallet-card-actions">
                                <button class="wallet-action-btn" id="new-send-btn"><i class="fa-solid fa-arrow-up"></i><span>Send</span></button>
                                <button class="wallet-action-btn" id="new-receive-btn"><i class="fa-solid fa-arrow-down"></i><span>Receive</span></button>
                                <button class="wallet-action-btn" id="new-fund-btn"><i class="fa-solid fa-building-columns"></i><span>Fund</span></button>
                                <button class="wallet-action-btn" id="new-history-btn"><i class="fa-solid fa-clock-rotate-left"></i><span>History</span></button>
                            </div>
                        </div>
                        <!-- Back Side (BTC) -->
                        <div class="wallet-card-face wallet-card-back">
                            <div class="wallet-card-header">
                                <span class="wallet-title">My Wallet (BTC) <i id="currency-switch-btn-back" class="fa-solid fa-rotate"></i></span>
                                <span class="wallet-ref-id" id="wallet-ref-id-back">****</span>
                            </div>
                            <div class="wallet-card-balance btc">
                                <span class="balance-amount" id="balance-btc">0.00000000</span>
                                <span class="balance-currency">BTC</span>
                            </div>
                            <div class="wallet-card-actions">
                                <button class="wallet-action-btn" id="new-send-btn-back"><i class="fa-solid fa-arrow-up"></i><span>Send</span></button>
                                <button class="wallet-action-btn" id="new-receive-btn-back"><i class="fa-solid fa-arrow-down"></i><span>Receive</span></button>
                                <button class="wallet-action-btn" id="new-fund-btn-back"><i class="fa-solid fa-building-columns"></i><span>Fund</span></button>
                                <button class="wallet-action-btn" id="new-history-btn-back"><i class="fa-solid fa-clock-rotate-left"></i><span>History</span></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Quick Transfer Section -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3>Quick BTC Transfer</h3>
                    </div>
                    <div class="quick-transfer-list" id="quick-transfer-list-container">
                        <div class="add-contact-btn" id="add-contact-btn"><i class="fa-solid fa-plus"></i></div>
                        <!-- Contact bubbles will be added here by JS -->
                    </div>
                </div>

                <!-- NEW: Recent Transactions Section -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3>Recent Transaction</h3>
                        <span class="see-more" id="recent-tx-see-more">See More ></span>
                    </div>
                    <div class="recent-tx-list" id="recent-tx-list-container">
                        <!-- Transactions will be populated here by JS -->
                    </div>
                </div>
                
                <div id="claim-miner-banner">
                    <h3>🎁 Your Referral Gift is Ready!</h3>
                    <p>Thanks for joining with a referral. Claim your free miner now and start earning!</p>
                    <button id="claim-miner-btn">Claim Free Miner</button>
                </div>

                <div id="dashboard-dynamic-content">
                    
                </div>
            </div>
            
            <div id="history-page" class="page">
                <div class="page-header">
                    <button id="history-back-btn" class="header-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>Transaction History</h2>
                </div>
                <div id="transaction-list" style="padding: 0 16px;"></div>
                <div id="no-transactions-message" style="display: none;">
                    <i class="fa-solid fa-receipt"></i>
                    <p>No transactions yet.</p>
                </div>
            </div>

            <!-- NEW: Level Details Page -->
            <div id="level-details-page" class="page">
                <div class="page-header">
                    <button id="level-details-back-btn" class="header-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="level-details-title">Level Users</h2>
                </div>
                <div class="search-bar-wrapper">
                    <div class="search-input-group">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="level-user-search" class="profile-input" placeholder="Search by name...">
                    </div>
                </div>
                <div id="level-user-list"></div>
                <div id="no-level-users-message" style="display: none;">
                    <p>No users found in this level yet.</p>
                </div>
            </div>

            <!-- PREMIUM Market Page -->
            <div id="market-page" class="page">
                <div class="page-header" style="padding: 24px 16px 0;">
                    <h2>Miner Devices</h2>
                </div>
                <div class="market-content" id="market-list-container">
                    <!-- Premium Miner list items will be dynamically inserted here -->
                </div>
            </div>

            <div id="booster-page" class="page">
                <div class="gauge-wrapper">
                    <div class="gauge-progress"></div>
                    <div class="gauge-scale"></div>
                    <div class="gauge-center-content">
                        <div class="gauge-value-box"><span id="gauge-value-int">0</span>.<span id="gauge-value-dec">00</span></div>
                        <div class="hash-rate"><div class="value" id="hash-rate-value">0.00</div><div class="label">Hash Rate TH/s</div></div>
                    </div>
                </div>

                <h2 class="section-title">Miner Status</h2>
                <div class="booster-grid">
                    <div class="booster-card active"><div class="icon-wrapper"><i class="fa-solid fa-arrow-trend-up"></i></div><div class="booster-info"><div class="status">Active</div><div class="devices"><span id="active-devices-count">0</span> Devices</div></div></div>
                    <div class="booster-card inactive"><div class="icon-wrapper"><i class="fa-solid fa-arrow-trend-down"></i></div><div class="booster-info"><div class="status">Inactive</div><div class="devices"><span id="inactive-devices-count">0</span> Devices</div></div></div>
                </div>
                <button id="manage-miners-btn"><i class="fa-solid fa-gears"></i> Manage My Miners</button>


                <h2 class="section-title">Member Status</h2>
                <div class="booster-grid">
                    <div class="booster-card online"><div class="icon-wrapper"><i class="fa-solid fa-user-check"></i></div><div class="booster-info"><div class="status">Online</div><div class="devices"><span id="online-users-count">0</span> Users</div></div></div>
                    <div class="booster-card offline"><div class="icon-wrapper"><i class="fa-solid fa-user-slash"></i></div><div class="booster-info"><div class="status">Offline</div><div class="devices"><span id="offline-users-count">0</span> Users</div></div></div>
                </div>

                <h2 class="section-title">Rewards</h2>
                <div class="rewards-container">
                    <div class="reward-card">
                        <div class="title">Today's Earning</div>
                        <div class="amount-btc" id="today-reward-btc">0.00000000 <span>BTC</span></div>
                        <div class="amount-usd" id="today-reward-usd">≈$0.00 USD</div>
                    </div>
                    <div class="reward-card">
                        <div class="title">Total Mining Reward</div>
                        <div class="amount-btc" id="reward-btc">0.00000000 <span>BTC</span></div>
                        <div class="amount-usd" id="reward-usd">≈$0.00 USD</div>
                    </div>
                </div>
            </div>

            <!-- NEW: My Miners Page -->
            <div id="my-miners-page" class="page">
                 <div class="page-header">
                    <button id="my-miners-back-btn" class="header-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>My Active Miners</h2>
                </div>
                <div class="my-miner-list" id="my-miner-list-container" style="padding: 0 16px;">
                    <!-- User's owned miners will be listed here -->
                </div>
            </div>

            <div id="community-page" class="page">
                <div class="page-header" style="padding: 24px 16px 0;">
                    <h2>My Community</h2>
                </div>
                <div class="community-content" style="padding: 0 16px;">
                    <div id="community-apply-view" style="display: none;">
                        <div class="apply-community-card">
                            <i class="fa-solid fa-users-gear"></i>
                            <h2>Unlock Referral Earnings</h2>
                            <p>Apply to create your own mining community. Invite others and earn commissions from their mining activity!</p>
                            <button id="apply-community-btn" class="auth-btn apply-community-btn">Apply Now</button>
                        </div>
                    </div>
                    
                    <div id="community-display-view" style="display: none;">
                        <div class="commission-balance-card">
                            <div class="balance-info">
                                <span class="label">Commission Balance</span>
                                <span class="amount-usd" id="commission-balance-usd">$0.00</span>
                            </div>
                            <button class="swap-btn" id="swap-commission-btn"><i class="fa-solid fa-right-left"></i> Swap</button>
                        </div>
                        
                        <div class="referral-code-card">
                            <span class="label">Your Referral Code</span>
                            <div class="code-box">
                                <span id="referral-code-text"></span>
                                <button class="copy-btn" id="copy-referral-btn"><i class="fa-solid fa-copy"></i></button>
                            </div>
                        </div>
                        
                        <div id="levels-list-container" class="levels-list">
                            <!-- Level cards will be dynamically generated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div id="profile-page" class="page"><div class="profile-header"><div class="profile-picture-wrapper"><img id="profile-page-pic" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Profile Picture"><label for="profile-pic-input" id="profile-pic-upload-label"><i class="fa-solid fa-camera"></i></label><input type="file" id="profile-pic-input" accept="image/*"></div><div class="user-name-wrapper" id="profile-page-name-wrapper"><h2 id="profile-page-name">User Name</h2><span id="profile-verified-icon" class="verified-badge"></span></div><p id="profile-page-email">user@example.com</p></div><div class="profile-section"><h3>Blockchain Address</h3><div class="profile-info-text" id="profile-full-address"></div></div><div class="profile-section"><h3>Verification</h3><div id="verification-card" class="verification-card"><div class="icon-wrapper"><i id="verification-icon" class="fa-solid fa-spinner fa-spin"></i></div><div class="info"><p id="verification-status-text" class="status-title">Checking...</p><p id="verification-description" class="description">Please wait while we check your verification status.</p></div><button id="send-verification-btn" class="action-btn" style="display: none;">Verify Now</button></div></div><div class="profile-section"><h3>Account Info</h3><form id="update-name-form"><div class="profile-input-group"><label for="update-name-input">Full Name</label><input type="text" id="update-name-input" class="profile-input" required></div><button type="submit" class="profile-btn">Update Name</button></form></div><div class="profile-section"><h3>Security</h3><form id="update-password-form"><div class="profile-input-group"><label for="current-password-input">Current Password</label><input type="password" id="current-password-input" class="profile-input" placeholder="Enter your current password" required></div><div class="profile-input-group"><label for="new-password-input">New Password</label><input type="password" id="new-password-input" class="profile-input" placeholder="Enter new password" required></div><div class="profile-input-group"><label for="confirm-password-input">Confirm New Password</label><input type="password" id="confirm-password-input" class="profile-input" placeholder="Confirm new password" required></div><button type="submit" class="profile-btn">Change Password</button><button type="button" id="forgot-password-btn" class="profile-btn" style="background-color: transparent; border: 1px solid var(--primary-orange); color: var(--primary-orange); margin-top: 10px;">Forgot Password</button></form></div><button id="logout-btn">Logout</button></div>
        </main>
        
        <div id="receive-page">
            <div class="flow-header">
                <button class="header-btn" id="receive-back-btn" style="background: rgba(255,255,255,0.1);"><i class="fa-solid fa-xmark"></i></button>
                <h2>Receive BTC</h2>
                <span></span>
            </div>
            <div class="receive-content">
                <div class="qr-code-container">
                    <div id="qr-code-canvas"></div>
                </div>
                <div class="receive-address-wrapper">
                    <p>Scan this code to receive BTC</p>
                    <div class="receive-address-box">
                        <span id="receive-page-address"></span>
                        <button id="receive-copy-btn"><i class="fa-solid fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="send-flow-page" class="flow-page">
            <div id="send-amount-step" class="flow-step">
                <div class="flow-header"><button class="header-btn" id="amount-back-btn"><i class="fa-solid fa-xmark"></i></button><h2>Send BTC</h2><button class="currency-toggle-btn" id="currency-toggle-btn"><i class="fa-solid fa-right-left"></i></button></div>
                <div style="padding: 10px 24px 0 24px; width: 100%; box-sizing: border-box;">
                    <label for="recipient-address-input" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; display: block;">To:</label>
                    <div class="address-input-wrapper">
                         <!-- Recipient Info Display -->
                        <div id="recipient-info-display">
                            <img id="recipient-info-pic" src="" alt="Recipient">
                            <div id="recipient-info-details">
                                <p id="recipient-info-name"></p>
                                <p id="recipient-info-address"></p>
                            </div>
                            <button id="clear-scanned-address-btn"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <!-- Original Input -->
                        <input type="text" id="recipient-address-input" class="profile-input" placeholder="Enter, paste or scan address">
                        <button class="qr-scan-btn-inline" id="qr-scan-btn-inline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-scan" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>
                        </button>
                    </div>
                    <p id="address-error-msg"></p>
                </div>
                <div class="amount-input-area" id="amount-input-area">
                    <div class="amount-display-wrapper">
                        <h1 id="send-amount-display" class="placeholder">0</h1>
                        <span id="amount-cursor" class="cursor"></span>
                        <span id="send-currency-unit">BTC</span>
                    </div>
                    <p id="send-amount-equivalent">~$0.00</p>
                    <p id="limit-error-msg"></p>
                </div>
                <div class="flow-footer">
                    <div class="available-balance-row">
                        <div><span>Available: </span><b id="available-to-send-btc">0.00 BTC</b></div>
                        <button id="send-max-btn">Max</button>
                    </div>
                    <button id="send-amount-next-btn" class="flow-next-btn" disabled>Next</button>
                </div>
                <input type="text" id="numeric-amount-input" inputmode="decimal" style="opacity: 0; position: absolute; top: -1000px; left: -1000px;">
            </div>
            <div id="send-confirmation-step" class="flow-step">
                <div class="flow-header"><button class="header-btn" id="confirm-back-btn"><i class="fa-solid fa-chevron-left"></i></button><h2>Confirm Transaction</h2><span></span></div>
                <div class="confirmation-summary">
                    <div class="summary-item"><span class="summary-label">To</span><div class="summary-value" id="confirm-recipient"></div></div>
                    <div class="summary-item"><span class="summary-label">You Send</span><div class="summary-value" id="confirm-amount-sent"></div></div>
                    <div class="summary-item"><span class="summary-label">Network Fee (2%)</span><div class="summary-value" id="confirm-fee"></div></div>
                    <div class="summary-item"><span class="summary-label"><b>Recipient Gets</b></span><div class="summary-value" id="confirm-amount-received"></div></div>
                </div>
                <div id="confirmation-footer">
                    <div class="swipe-container" id="send-swipe-container">
                        <div class="swipe-track-fill" id="send-swipe-track-fill"></div>
                        <div class="swipe-thumb" id="send-swipe-thumb"><i class="fa-solid fa-chevron-right"></i></div>
                        <span class="swipe-text" id="send-swipe-text">Swipe to Confirm</span>
                    </div>
                </div>
            </div>
            <div id="send-success-step" class="flow-step">
                <div class="flow-success-content">
                    <i class="fa-brands fa-btc btc-animation-icon"></i>
                    <div class="success-main-content">
                        <h2>Transaction Sent!</h2>
                        <p>You have successfully sent <b id="success-amount-sent">0 BTC</b>.</p>
                        <div class="success-details">
                            <div class="summary-item"><span class="summary-label">To</span><span class="summary-value" id="success-recipient"></span></div>
                            <div class="summary-item"><span class="summary-label">Time</span><span class="summary-value" id="success-time"></span></div>
                            <div class="summary-item"><span class="summary-label">Transaction ID</span><span class="summary-value" id="success-txid"></span></div>
                        </div>
                    </div>
                </div>
                <button id="send-done-btn" class="flow-next-btn" style="margin: 24px;">Done</button>
            </div>
        </div>

        <div id="fund-flow-page" class="flow-page">
            <div id="fund-choice-step" class="flow-step">
                <div class="flow-header"><button class="header-btn" id="fund-choice-back-btn"><i class="fa-solid fa-xmark"></i></button><h2>Fund Your Account</h2><span></span></div>
                <div class="fund-flow-content">
                    <div class="fund-choice-card" id="go-to-deposit-btn">
                        <div class="icon-wrapper"><i class="fa-solid fa-download"></i></div>
                        <div class="info">
                            <h3>Deposit BTC</h3>
                            <p>Receive Bitcoin from an external wallet.</p>
                        </div>
                    </div>
                    <div class="fund-choice-card" id="go-to-withdraw-btn">
                         <div class="icon-wrapper"><i class="fa-solid fa-upload"></i></div>
                        <div class="info">
                            <h3>Withdraw BTC</h3>
                            <p>Send Bitcoin to your external wallet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="fund-deposit-step" class="flow-step">
                <div class="flow-header"><button class="header-btn" id="deposit-back-btn"><i class="fa-solid fa-chevron-left"></i></button><h2>Deposit BTC</h2><span></span></div>
                <div class="fund-flow-content">
                    <p style="color: var(--text-secondary); text-align:left; font-size: 14px; margin: 0 0 16px 0;">Send any amount of BTC (min $15) to the address below.</p>
                    <div class="fund-card deposit-address-container">
                        <img src="" id="deposit-qr-image" alt="Deposit QR Code">
                        <div class="deposit-address-box">
                            <span id="deposit-address">Loading...</span>
                            <button id="deposit-copy-address-btn"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </div>
                     <p style="color: var(--text-secondary); text-align:left; font-size: 14px; margin: 24px 0 16px 0;">After sending, enter the details below to credit your account.</p>
                     <div class="fund-card">
                        <div class="profile-input-group">
                            <label>Amount (USD)</label>
                            <input type="number" id="deposit-amount-usd" class="profile-input" placeholder="e.g., 100" required>
                        </div>
                        <div class="profile-input-group">
                            <label>Transaction ID (TXID)</label>
                            <input type="text" id="deposit-txid" class="profile-input" placeholder="Paste the transaction ID from your wallet" required>
                        </div>
                        <div class="profile-input-group file-upload-wrapper" style="display: none;">
                            <label>Screenshot (Optional)</label>
                            <label for="deposit-screenshot-input" class="file-upload-label">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Image
                            </label>
                            <input type="file" id="deposit-screenshot-input" accept="image/*" style="display:none;">
                            <span id="screenshot-file-name">No file chosen</span>
                        </div>
                    </div>
                </div>
                <div id="deposit-footer" class="flow-footer">
                     <div class="swipe-container" id="deposit-swipe-container">
                        <div class="swipe-track-fill" id="deposit-swipe-track-fill"></div>
                        <div class="swipe-thumb" id="deposit-swipe-thumb"><i class="fa-solid fa-chevron-right"></i></div>
                        <span class="swipe-text" id="deposit-swipe-text">Swipe to Submit</span>
                    </div>
                </div>
            </div>

            <div id="fund-withdraw-step" class="flow-step">
                <div class="flow-header"><button class="header-btn" id="withdraw-back-btn"><i class="fa-solid fa-chevron-left"></i></button><h2>Withdraw BTC</h2><span></span></div>
                <div class="fund-flow-content">
                    <p style="color: var(--text-secondary); text-align:left; font-size: 14px; margin: 0 0 16px 0;">Enter withdrawal details. Minimum withdrawal is $100.</p>
                     <div class="fund-card">
                        <div class="profile-input-group">
                            <label>Amount (USD)</label>
                            <input type="number" id="withdraw-amount-usd" class="profile-input" placeholder="e.g., 150" required>
                        </div>
                        <div class="profile-input-group">
                            <label>Your BTC Address</label>
                            <input type="text" id="withdraw-btc-address" class="profile-input" placeholder="Paste your receiving BTC address" required>
                        </div>
                        <div class="profile-input-group">
                            <label>Confirm Your Password</label>
                            <input type="password" id="withdraw-password" class="profile-input" placeholder="Enter your account password" required>
                        </div>
                    </div>
                </div>
                <div id="withdraw-footer" class="flow-footer">
                     <div class="swipe-container" id="withdraw-swipe-container">
                        <div class="swipe-track-fill" id="withdraw-swipe-track-fill"></div>
                        <div class="swipe-thumb" id="withdraw-swipe-thumb"><i class="fa-solid fa-chevron-right"></i></div>
                        <span class="swipe-text" id="withdraw-swipe-text">Swipe to Request</span>
                    </div>
                </div>
            </div>

            <div id="fund-status-step" class="flow-step">
                 <div class="status-content">
                    <div class="status-icon-wrapper">
                        <i id="fund-status-icon"></i>
                    </div>
                    <h2 id="fund-status-title"></h2>
                    <p id="fund-status-message"></p>
                </div>
                <button id="fund-done-btn" class="flow-next-btn" style="margin: 24px;">Done</button>
            </div>

        </div>

        <!-- Purchase & Upgrade Flow Pages -->
        <div id="purchase-flow-page" class="flow-page">
            <!-- Product Details Step -->
            <div id="product-details-step" class="flow-step">
                <div class="flow-header">
                    <button class="header-btn" id="product-details-back-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>Miner Details</h2>
                    <span></span>
                </div>
                <div class="product-details-content">
                    <img id="product-details-image" src="" alt="Miner Image">
                    <h2 id="product-details-name"></h2>
                    <p id="product-details-description"></p>
                    
                    <div class="quantity-selector">
                        <button class="quantity-btn" id="quantity-minus-btn">-</button>
                        <span id="product-quantity">1</span>
                        <button class="quantity-btn" id="quantity-plus-btn">+</button>
                    </div>

                    <div class="price-details">
                        <span id="product-original-price"></span>
                        <h3 id="product-discounted-price"></h3>
                    </div>
                </div>
                <div class="flow-footer">
                    <button id="product-confirm-btn" class="flow-next-btn" style="background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));">Confirm Purchase</button>
                </div>
            </div>

            <!-- Purchase Confirmation Step -->
            <div id="purchase-confirmation-step" class="flow-step">
                <div class="flow-header">
                    <button class="header-btn" id="purchase-confirm-back-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>Confirm Purchase</h2>
                    <span></span>
                </div>
                <div class="confirmation-summary">
                    <div class="summary-item">
                        <span class="summary-label">Item</span>
                        <div class="summary-value" id="confirm-purchase-name"></div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Quantity</span>
                        <div class="summary-value" id="confirm-purchase-quantity"></div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Cost</span>
                        <div class="summary-value" id="confirm-purchase-cost"></div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label"><b>Your Balance After</b></span>
                        <div class="summary-value" id="confirm-purchase-balance-after"></div>
                    </div>
                </div>
                <div id="confirmation-footer">
                    <div class="swipe-container" id="purchase-swipe-container">
                        <div class="swipe-track-fill" id="purchase-swipe-track-fill"></div>
                        <div class="swipe-thumb" id="purchase-swipe-thumb"><i class="fa-solid fa-chevron-right"></i></div>
                        <span class="swipe-text" id="purchase-swipe-text">Swipe to Purchase</span>
                    </div>
                </div>
            </div>

            <!-- NEW: Upgrade Flow -->
            <div id="upgrade-details-step" class="flow-step">
                 <div class="flow-header">
                    <button class="header-btn" id="upgrade-details-back-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>Upgrade Miner</h2>
                    <span></span>
                </div>
                <div class="upgrade-flow-content">
                    <div class="upgrade-card-wrapper">
                        <div class="label">FROM</div>
                        <div id="upgrade-from-card" class="market-list-item"></div>
                    </div>

                    <i class="fa-solid fa-arrow-down upgrade-arrow"></i>

                    <div class="upgrade-card-wrapper">
                        <div class="label">TO</div>
                        <div id="upgrade-to-card" class="market-list-item"></div>
                    </div>

                    <div id="upgrade-cost-summary">
                        <div class="label">Upgrade Cost</div>
                        <div id="upgrade-cost"></div>
                    </div>
                </div>
                <div class="flow-footer">
                    <button id="upgrade-confirm-btn" class="flow-next-btn" style="background: linear-gradient(90deg, var(--primary-purple), #8162ff);">Confirm Upgrade</button>
                </div>
            </div>

            <div id="upgrade-confirmation-step" class="flow-step">
                <div class="flow-header">
                    <button class="header-btn" id="upgrade-confirm-back-btn"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2>Confirm Upgrade</h2>
                    <span></span>
                </div>
                <div class="confirmation-summary">
                     <div class="summary-item">
                        <span class="summary-label">Action</span>
                        <div class="summary-value" id="confirm-upgrade-action"></div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Cost</span>
                        <div class="summary-value" id="confirm-upgrade-cost"></div>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label"><b>Your Balance After</b></span>
                        <div class="summary-value" id="confirm-upgrade-balance-after"></div>
                    </div>
                </div>
                <div id="confirmation-footer">
                    <div class="swipe-container" id="upgrade-swipe-container">
                        <div class="swipe-track-fill" id="upgrade-swipe-track-fill"></div>
                        <div class="swipe-thumb" id="upgrade-swipe-thumb"><i class="fa-solid fa-chevron-right"></i></div>
                        <span class="swipe-text" id="upgrade-swipe-text">Swipe to Upgrade</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- NEW 3D NAVIGATION BAR -->
    <nav class="new-bottom-nav">
        <div class="nav-items-group">
            <div class="new-nav-item" data-page="dashboard-page">
                <div class="nav-icon-wrapper"><i class="fa-solid fa-house"></i></div>
            </div>
            <div class="new-nav-item" data-page="market-page">
                <div class="nav-icon-wrapper"><i class="fa-solid fa-store"></i></div>
            </div>
            <div class="nav-placeholder"></div> <!-- Placeholder for the center button -->
            <div class="new-nav-item" data-page="community-page">
                <div class="nav-icon-wrapper"><i class="fa-solid fa-users"></i></div>
            </div>
            <div class="new-nav-item" data-page="profile-page">
                <div class="nav-icon-wrapper"><i class="fa-solid fa-user"></i></div>
            </div>
        </div>
        <div class="nav-center-button" data-page="booster-page">
            <i class="fa-solid fa-bolt"></i>
        </div>
    </nav>

    <div class="loading-overlay"><div class="spinner"></div></div>
    <div class="qr-scanner-overlay" id="qr-scanner-overlay"><video id="qr-video" playsinline></video><div class="scanner-content"><div id="permission-message" style="display: none;"></div><div class="scanner-box"><div class="scanner-line"></div></div><label for="qr-file-input" class="scanner-upload-label"><i class="fa-solid fa-upload"></i> Upload from File</label><input type="file" id="qr-file-input" accept="image/*"></div><button class="close-scanner-btn" id="close-scanner-btn"><i class="fa-solid fa-xmark"></i></button><canvas id="qr-canvas" style="display: none;"></canvas></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. FIREBASE & GLOBAL INITIALIZATION ---
            const firebaseConfig = { apiKey: "AIzaSyBfPv3ESbWw2CYIJuS6C3vQ3WNShf9V0_s", authDomain: "viptask-5c1fc.firebaseapp.com", databaseURL: "https://viptask-5c1fc-default-rtdb.firebaseio.com", projectId: "viptask-5c1fc", storageBucket: "viptask-5c1fc.appspot.com", messagingSenderId: "755395733575", appId: "1:755395733575:web:ded7e94e433a76e73e1c6b" };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth(); 
            const db = firebase.database();
            const storage = firebase.storage();
            
            // --- GLOBAL STATE ---
            let btcPrice = 65000;
            let adminSettings = {};
            let minerProducts = {}; 
            const SEND_LIMIT_USD = 10000;
            const MIN_SEND_USD = 10;
            const MIN_DEPOSIT_USD = 15;
            const MIN_WITHDRAW_USD = 100;
            let currentUserData = {};
            let isDuringRegistration = false;
            let gaugeAnimationInterval = null;
            const FREE_MINER_ID = 'free_miner_referral';
            let preferredCurrencyView = localStorage.getItem('currencyView') || 'USDT';
            const DEFAULT_PROFILE_PIC = 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/31b098de3ca86934523e346c6c585c8f.jpg?alt=media&token=556d831a-d4a1-4306-bf1e-21e5f2da60f1';
            let contactToAdd = null; // For the add contact flow

            
            const splashScreen = document.getElementById('splash-screen');
            const authOverlay = document.getElementById('auth-overlay'); 
            const appContainer = document.querySelector('.app-container'); 
            const bottomNav = document.querySelector('.new-bottom-nav'); // Updated selector
            const loadingOverlay = document.querySelector(".loading-overlay");
            
            // --- 2. NEW SPLASH SCREEN LOGIC ---
            function runSplashScreen() {
                const logo1 = document.getElementById('splash-logo1');
                const logo2 = document.getElementById('splash-logo2');
                
                setTimeout(() => { logo1.classList.add('visible'); }, 100);
                setTimeout(() => { logo1.classList.remove('visible'); logo2.classList.add('visible'); }, 1800);
            }
            runSplashScreen(); // Run it on initial load

            // --- 3. AUTHENTICATION LOGIC ---
            const loginPage = document.getElementById('auth-login-page');
            const registerPage = document.getElementById('auth-register-page');
            const showRegisterBtn = document.getElementById('show-register'); 
            const showLoginBtn = document.getElementById('show-login');
            const referralPopup = document.getElementById('referral-popup');
            const closeReferralPopupBtn = document.getElementById('close-referral-popup');
            
            function switchAuthPage(pageToShow) {
                const activeAuthPage = document.querySelector('.auth-page.active');
                if (activeAuthPage) {
                    activeAuthPage.querySelectorAll('h2, .input-group, .auth-btn, .toggle-link').forEach(el => el.style.opacity = 0);
                }

                if (pageToShow === 'register') { 
                    loginPage.classList.remove('active'); loginPage.classList.add('inactive-left'); 
                    registerPage.classList.remove('inactive-right'); registerPage.classList.add('active'); 
                } else { 
                    registerPage.classList.remove('active'); registerPage.classList.add('inactive-right'); 
                    loginPage.classList.remove('inactive-left'); loginPage.classList.add('active'); 
                } 
            }
            showRegisterBtn.addEventListener('click', () => { referralPopup.style.display = 'flex'; });
            closeReferralPopupBtn.addEventListener('click', () => { referralPopup.style.display = 'none'; switchAuthPage('register'); });
            showLoginBtn.addEventListener('click', () => switchAuthPage('login'));
            loginPage.classList.add('active'); registerPage.classList.add('inactive-right');
            
            function generateEthereumAddress() { let address = '0x'; const characters = '0123456789abcdef'; for (let i = 0; i < 40; i++) { address += characters.charAt(Math.floor(Math.random() * characters.length)); } return address; }
            
            const registerForm = document.getElementById('register-form-fields');
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const referralCode = document.getElementById('register-referral-code').value.trim();
                document.getElementById('register-error').textContent = '';
                const registerBtn = document.getElementById('register-btn');
                registerBtn.disabled = true;
                registerBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Registering...`;

                auth.createUserWithEmailAndPassword(email, password).then(async (userCredential) => {
                    isDuringRegistration = true;
                    const user = userCredential.user;
                    const initialUserData = {
                        name: name, email: email, createdAt: firebase.database.ServerValue.TIMESTAMP, btcBalance: 0,
                        blockchainAddress: generateEthereumAddress(), communityStatus: 'none', commissionBalance: 0,
                        sendUnlocked: false, purchasedMiners: {}, totalHashRate: 0, activeDevices: 0,
                        inactiveDevices: 0, lastRewardClaimed: firebase.database.ServerValue.TIMESTAMP,
                        totalReward: 0, onlineUsers: 0, offlineUsers: 0, freeMinerClaimed: false
                    };

                    if (referralCode) {
                        const referrerQuery = db.ref('users').orderByChild('referralCode').equalTo(referralCode).limitToFirst(1);
                        const snapshot = await referrerQuery.once('value');
                        if (snapshot.exists()) {
                            const referrerId = Object.keys(snapshot.val())[0];
                            initialUserData.referredBy = referrerId;
                            db.ref(`users/${referrerId}`).update({ offlineUsers: firebase.database.ServerValue.increment(1) });
                            let currentReferrerId = referrerId;
                            for (let level = 1; level <= 12 && currentReferrerId; level++) {
                                db.ref(`users/${currentReferrerId}/referralLevels/level${level}/users`).transaction(currentCount => (currentCount || 0) + 1);
                                const parentSnapshot = await db.ref(`users/${currentReferrerId}/referredBy`).once('value');
                                currentReferrerId = parentSnapshot.val(); 
                            }
                        }
                    }

                    return db.ref('users/' + user.uid).set(initialUserData).then(() => {
                        user.sendEmailVerification();
                        document.getElementById('success-modal').style.display = 'flex';
                        registerForm.reset();
                        setTimeout(() => {
                            document.getElementById('success-modal').style.display = 'none';
                            authOverlay.style.display = 'none';
                            appContainer.style.display = 'block';
                            isDuringRegistration = false;
                        }, 5000);
                    });
                }).catch((error) => {
                    document.getElementById('register-error').textContent = error.message;
                    isDuringRegistration = false;
                }).finally(() => {
                    registerBtn.disabled = false;
                    registerBtn.innerHTML = 'Register';
                });
            });

            const loginForm = document.getElementById('login-form-fields');
            const loginBtn = document.getElementById('login-btn');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                document.getElementById('login-error').textContent = '';
                loginBtn.disabled = true;
                loginBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Logging In...`;
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => { document.getElementById('login-error').textContent = error.message; })
                    .finally(() => { loginBtn.disabled = false; loginBtn.innerHTML = 'Login'; });
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); });

            auth.onAuthStateChanged(user => {
                if (isDuringRegistration) return;
                if (user) {
                    authOverlay.style.display = 'none';
                    appContainer.style.display = 'block';
                    initializeAppData(user);
                } else {
                    resetAppState(); 
                    appContainer.style.display = 'none';
                    authOverlay.style.display = 'flex';
                }
                setTimeout(() => {
                    splashScreen.style.opacity = '0';
                    setTimeout(() => { splashScreen.style.display = 'none'; }, 500);
                }, 3000);
            });

            let userRefListener = null, adminRefListener = null, productsRefListener = null, txRefListener = null, quickContactsListener = null;
            
            function resetAppState() {
                currentUserData = {};
                if (userRefListener && auth.currentUser) db.ref('users/' + auth.currentUser.uid).off('value', userRefListener);
                if (adminRefListener) db.ref('admin').off('value', adminRefListener);
                if (productsRefListener) db.ref('products').off('value', productsRefListener);
                if (txRefListener && auth.currentUser) db.ref('transactions/' + auth.currentUser.uid).off('value', txRefListener);
                if (quickContactsListener && auth.currentUser) db.ref(`users/${auth.currentUser.uid}/quickContacts`).off('value', quickContactsListener);

                userRefListener = adminRefListener = productsRefListener = txRefListener = quickContactsListener = null;
                
                document.getElementById('balance-usdt').textContent = '0.00';
                document.getElementById('balance-btc').textContent = '0.00000000';
                document.getElementById('user-display-name').textContent = 'User';
                document.getElementById('dashboard-short-address').textContent = '';
                document.getElementById('transaction-list').innerHTML = '';
                document.getElementById('no-transactions-message').style.display = 'block';
                document.getElementById('market-list-container').innerHTML = '';
                document.getElementById('my-miner-list-container').innerHTML = '';
                document.getElementById('commission-balance-usd').textContent = '$0.00';
                document.getElementById('levels-list-container').innerHTML = '';
                document.getElementById('claim-miner-banner').style.display = 'none';
                
                if (gaugeAnimationInterval) clearInterval(gaugeAnimationInterval);
                showPage('dashboard-page');
            }

            function initializeAppData(user) { 
                resetAppState();
                const adminRef = db.ref('admin');
                adminRefListener = adminRef.on('value', (snapshot) => {
                    adminSettings = snapshot.val() || {};
                    btcPrice = parseFloat(adminSettings.btcPrice) || 65000;
                    updateAllPriceDisplays();
                    checkAndShowFreeMinerBanner();
                });

                const productsRef = db.ref('products');
                productsRefListener = productsRef.on('value', (snapshot) => {
                    minerProducts = snapshot.val() || {};
                    populateMarket();
                    populateMyMiners(); 
                });
                
                const userRef = db.ref('users/' + user.uid); 
                userRefListener = userRef.on('value', async (snapshot) => { 
                    const data = snapshot.val(); 
                    if (data) { 
                        currentUserData = { ...data, uid: user.uid, email: user.email };
                        await calculateAndApplyMiningRewards(user.uid, data);
                        const updatedSnapshot = await userRef.once('value');
                        currentUserData = { ...updatedSnapshot.val(), uid: user.uid, email: user.email };
                        
                        updateUserUI(user, currentUserData);
                        updateAllPriceDisplays();
                        updateCommunityUI(currentUserData); 
                        populateMyMiners();
                        calculateTodaysEarnings(user.uid);
                        checkAndShowFreeMinerBanner();
                        populateRecentTransactions(user.uid);
                    } 
                }); 
                
                // --- NEW: Listener for Quick Contacts ---
                const quickContactsRef = db.ref(`users/${user.uid}/quickContacts`);
                quickContactsListener = quickContactsRef.on('value', snapshot => {
                    populateQuickTransfer(snapshot.val());
                });

                createGaugeScale();
            }
            
            async function calculateAndApplyMiningRewards(userId, userData) {
                const allPossibleMiners = {...minerProducts};
                if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; }
                if (!userData.activeDevices || userData.activeDevices <= 0 || Object.keys(allPossibleMiners).length === 0) return; 

                let totalDailyRewardUSD = 0;
                const purchased = userData.purchasedMiners || {};
                for (const productId in purchased) {
                    const productData = allPossibleMiners[productId];
                    if (productData && productData.dailyRewardUSD) { totalDailyRewardUSD += productData.dailyRewardUSD * (purchased[productId] || 0); }
                }
                const totalDevices = (userData.activeDevices || 0) + (userData.inactiveDevices || 0);
                totalDailyRewardUSD = totalDevices > 0 ? (totalDailyRewardUSD / totalDevices) * userData.activeDevices : 0;
                if (totalDailyRewardUSD <= 0) return;

                const rewardPerIntervalUSD = totalDailyRewardUSD / 4, intervalMillis = 6 * 60 * 60 * 1000; 
                const now = Date.now(), lastClaimed = userData.lastRewardClaimed || userData.createdAt || now;
                let pendingIntervals = Math.floor((now - lastClaimed) / intervalMillis);
                
                if (pendingIntervals > 0) {
                    let totalEarnedBTC = 0, totalEarnedUSD = 0;
                    const txRef = db.ref('transactions/' + userId);
                    const newLastClaimed = lastClaimed + (pendingIntervals * intervalMillis);
                    
                    for (let i = 0; i < pendingIntervals; i++) {
                        const randomFactor = 0.7 + Math.random() * 0.8; 
                        const earnedThisIntervalUSD = rewardPerIntervalUSD * randomFactor;
                        const earnedThisIntervalBTC = earnedThisIntervalUSD / btcPrice;
                        totalEarnedBTC += earnedThisIntervalBTC;
                        totalEarnedUSD += earnedThisIntervalUSD;
                        txRef.push().set({ type: 'mining', amountBTC: earnedThisIntervalBTC, amountUSD: earnedThisIntervalUSD, timestamp: lastClaimed + ((i + 1) * intervalMillis) });
                    }
                    
                    if(totalEarnedBTC > 0){
                        const updates = {};
                        updates[`/users/${userId}/btcBalance`] = firebase.database.ServerValue.increment(totalEarnedBTC);
                        updates[`/users/${userId}/totalReward`] = firebase.database.ServerValue.increment(totalEarnedBTC);
                        updates[`/users/${userId}/lastRewardClaimed`] = newLastClaimed;
                        
                        if (userData.referredBy && totalEarnedUSD > 0) {
                            const commissionRates = [0.05, 0.03, 0.02, 0.02, 0.02, 0.02, 0.02, 0.01, 0.01, 0.01, 0.01, 0.01];
                            let currentReferrerId = userData.referredBy;
                            for (let level = 1; level <= 12 && currentReferrerId; level++) {
                                const commissionAmount = totalEarnedUSD * commissionRates[level - 1];
                                if (commissionAmount > 0) {
                                    updates[`/users/${currentReferrerId}/commissionBalance`] = firebase.database.ServerValue.increment(commissionAmount);
                                    updates[`/users/${currentReferrerId}/referralLevels/level${level}/earnings`] = firebase.database.ServerValue.increment(commissionAmount);
                                }
                                const parentSnapshot = await db.ref(`users/${currentReferrerId}/referredBy`).once('value');
                                currentReferrerId = parentSnapshot.val();
                            }
                        }
                        await db.ref().update(updates);
                        showToast(`${pendingIntervals} mining reward(s) claimed! +${totalEarnedBTC.toFixed(8)} BTC`);
                    }
                }
            }
            
            function calculateAndDisplayBalanceChange(todaysEarningsUSD) {
                const totalBalanceUSD = (currentUserData.btcBalance || 0) * btcPrice;
                const startingBalance = totalBalanceUSD - todaysEarningsUSD;
                let percentage = 0;
                if (startingBalance > 0) {
                    percentage = (todaysEarningsUSD / startingBalance) * 100;
                }
                const changeElement = document.getElementById('balance-change-usdt');
                changeElement.textContent = `+${percentage.toFixed(2)}%`;
            }

            function calculateTodaysEarnings(userId) {
                const now = new Date(); const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                db.ref('transactions/' + userId).orderByChild('timestamp').startAt(startOfToday).once('value', (snapshot) => {
                    let todaysEarningsUSD = 0;
                    if(snapshot.exists()) { snapshot.forEach(txSnap => { const tx = txSnap.val(); if (tx.type === 'mining') { todaysEarningsUSD += tx.amountUSD || 0; } }); }
                    document.getElementById('today-reward-usd').textContent = `≈$${todaysEarningsUSD.toFixed(2)} USD`;
                    document.getElementById('today-reward-btc').innerHTML = `${(todaysEarningsUSD / btcPrice).toFixed(8)} <span>BTC</span>`;
                    calculateAndDisplayBalanceChange(todaysEarningsUSD);
                });
            }


            function updateAllPriceDisplays() {
                if (!currentUserData.uid) return;
                // New Dashboard Card Balance
                const usdtBalance = (currentUserData.btcBalance || 0) * btcPrice;
                const btcBalance = currentUserData.btcBalance || 0;
                document.getElementById('balance-usdt').textContent = usdtBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('balance-btc').textContent = btcBalance.toFixed(8);

                // Other displays
                document.getElementById('available-to-send-btc').textContent = `${btcBalance.toFixed(8)} BTC`;
                const totalReward = currentUserData.totalReward || 0;
                document.getElementById('reward-btc').innerHTML = `${totalReward.toFixed(8)} <span>BTC</span>`;
                document.getElementById('reward-usd').textContent = `≈$${(totalReward * btcPrice).toFixed(2)} USD`;
                if(document.getElementById('history-page').classList.contains('active')){ loadTransactionHistory(auth.currentUser); }
                const userName = currentUserData.name || 'User';
                document.getElementById('user-display-name').textContent = userName;
                document.getElementById('profile-page-name').textContent = userName;
                document.getElementById('update-name-input').value = userName;
                updateBlockchainAddressUI(currentUserData.blockchainAddress);
                document.getElementById('active-devices-count').textContent = currentUserData.activeDevices || 0;
                document.getElementById('inactive-devices-count').textContent = currentUserData.inactiveDevices || 0;
                document.getElementById('online-users-count').textContent = currentUserData.onlineUsers || 0;
                document.getElementById('offline-users-count').textContent = currentUserData.offlineUsers || 0;
                updateGauge(currentUserData.totalHashRate || 0);
                document.getElementById('commission-balance-usd').textContent = `$${(currentUserData.commissionBalance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            function showToast(message, isError = false) { const toast = document.getElementById('toast-notification'); toast.textContent = message; toast.className = 'toast-notification'; if (isError) { toast.classList.add('error'); } toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
            
            function updateUserUI(user, dbData) { 
                const photoURL = dbData?.photoURL || user.photoURL; 
                const profilePicImg = document.getElementById('user-profile-pic');
                const profilePagePic = document.getElementById('profile-page-pic'); 

                if (photoURL) { 
                    profilePicImg.src = photoURL;
                    profilePagePic.src = photoURL;
                } else { 
                    profilePicImg.src = DEFAULT_PROFILE_PIC;
                    profilePagePic.src = DEFAULT_PROFILE_PIC;
                } 
                document.getElementById('profile-page-email').textContent = user.email; 
                updateVerificationStatus(user); 
                const sendUnlocked = dbData && dbData.sendUnlocked;
                document.querySelectorAll('.wallet-action-btn[id*="send-btn"]').forEach(btn => btn.disabled = !sendUnlocked);
                
                // Update referral ID on wallet card
                const refIdElement = document.getElementById('wallet-ref-id');
                const refIdElementBack = document.getElementById('wallet-ref-id-back');
                if (dbData.communityStatus === 'approved' && dbData.referralCode) {
                    refIdElement.textContent = `@${dbData.referralCode}`;
                    refIdElementBack.textContent = `@${dbData.referralCode}`;
                } else {
                    refIdElement.textContent = '****';
                    refIdElementBack.textContent = '****';
                }
            }

            function updateVerificationStatus(user) { 
                const verificationCard = document.getElementById('verification-card'), verificationIcon = document.getElementById('verification-icon'), verificationStatusText = document.getElementById('verification-status-text'), verificationDescription = document.getElementById('verification-description'), sendVerificationBtn = document.getElementById('send-verification-btn'), dashboardVerifiedIcon = document.getElementById('dashboard-verified-icon'), profileVerifiedIcon = document.getElementById('profile-verified-icon');
                const verifiedSVG = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="100%" height="100%" viewBox="0 0 256 256" xml:space="preserve"><g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)"><path d="M 43.131 54.997 c -0.762 0 -1.524 -0.29 -2.104 -0.87 l -7.625 -7.624 c -1.16 -1.16 -1.16 -3.048 0 -4.209 l 2.25 -2.25 c 1.16 -1.16 3.047 -1.16 4.208 0 l 3.271 3.271 l 7.009 -7.009 c 1.123 -1.123 3.084 -1.125 4.209 0 l 2.249 2.25 c 1.16 1.16 1.16 3.048 0 4.208 L 45.235 54.127 C 44.655 54.707 43.893 54.997 43.131 54.997 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(39, 199, 137); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/><path d="M 75.712 12.984 C 64.973 11.03 55.602 6.991 47.859 0.979 c -1.684 -1.307 -4.035 -1.307 -5.719 0 C 34.398 6.991 25.028 11.03 14.288 12.984 h 0 c -2.231 0.405 -3.85 2.352 -3.85 4.628 v 32.527 c 0 17.479 12.668 32.98 32.272 39.492 c 0.738 0.245 1.514 0.368 2.29 0.368 s 1.552 -0.123 2.29 -0.368 c 19.604 -6.511 32.271 -22.013 32.271 -39.492 V 17.612 C 79.562 15.335 77.942 13.389 75.712 12.984 z M 45 65.5 c -11.855 0 -21.5 -9.645 -21.5 -21.5 c 0 -11.855 9.645 -21.5 21.5 -21.5 c 11.855 0 21.5 9.645 21.5 21.5 C 66.5 55.855 56.855 65.5 45 65.5 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(39, 199, 137); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/></g></svg>`;
                user.reload().then(() => { 
                    if (user.emailVerified) { 
                        verificationCard.className = 'verification-card verified'; verificationIcon.className = 'fa-solid fa-check'; verificationStatusText.textContent = 'Verified'; verificationDescription.textContent = 'Your email address has been successfully verified.'; sendVerificationBtn.style.display = 'none'; dashboardVerifiedIcon.innerHTML = verifiedSVG; profileVerifiedIcon.innerHTML = verifiedSVG;
                    } else { 
                        verificationCard.className = 'verification-card not-verified'; verificationIcon.className = 'fa-solid fa-triangle-exclamation'; verificationStatusText.textContent = 'Not Verified'; verificationDescription.textContent = 'Please verify your email to secure your account.'; sendVerificationBtn.style.display = 'block'; dashboardVerifiedIcon.innerHTML = ''; profileVerifiedIcon.innerHTML = '';
                    } 
                }); 
            }

            let fullAddress = ''; function updateBlockchainAddressUI(address) { if (!address) return; fullAddress = address; const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`; document.getElementById('dashboard-short-address').textContent = shortAddress; document.getElementById('profile-full-address').textContent = address; }
            document.getElementById('dashboard-address-container').addEventListener('click', () => { if (fullAddress) { navigator.clipboard.writeText(fullAddress).then(() => { showToast('Address copied to clipboard!'); }); } });
            document.getElementById('send-verification-btn').addEventListener('click', () => { const user = auth.currentUser; if (user) { user.sendEmailVerification().then(() => { showToast('Verification email sent!'); }).catch(error => { showToast('Error: ' + error.message, true); }); } });
            document.getElementById('forgot-password-btn').addEventListener('click', () => { const user = auth.currentUser; if(user && user.email) { auth.sendPasswordResetEmail(user.email).then(() => { showToast('Password reset email sent to ' + user.email); }).catch((error) => { showToast('Error sending reset email: ' + error.message, true); }); } else { showToast('Could not find user email.', true); } });
            document.getElementById('update-password-form').addEventListener('submit', async (e) => { e.preventDefault(); const currentPassword = document.getElementById('current-password-input').value; const newPassword = document.getElementById('new-password-input').value; const confirmPassword = document.getElementById('confirm-password-input').value; const user = auth.currentUser; if (newPassword !== confirmPassword) { showToast("New passwords do not match.", true); return; } if (!user) { showToast("No user is signed in.", true); return; } try { const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword); await user.reauthenticateWithCredential(credential); await user.updatePassword(newPassword); showToast("Password updated successfully!"); document.getElementById('update-password-form').reset(); } catch (error) { showToast(error.code === 'auth/wrong-password' ? "Incorrect current password." : "An error occurred: " + error.message, true); } });
            document.getElementById('update-name-form').addEventListener('submit', (e) => { e.preventDefault(); const newName = document.getElementById('update-name-input').value; const user = auth.currentUser; if (user && newName) { db.ref('users/' + user.uid).update({ name: newName }).then(() => { showToast('Name updated!'); }).catch(error => showToast(error.message, true)); }});
            document.getElementById('profile-pic-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(event) { document.getElementById('user-profile-pic').src = event.target.result; document.getElementById('profile-page-pic').src = event.target.result; }; reader.readAsDataURL(file); const user = auth.currentUser; if (!user) return; const storageRef = storage.ref(`profile_pictures/${user.uid}/${file.name}`); const uploadTask = storageRef.put(file); uploadTask.on('state_changed', null, (error) => { showToast("Upload Error: " + error.message, true); }, () => { uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => { user.updateProfile({ photoURL: downloadURL }); return db.ref('users/' + user.uid).update({ photoURL: downloadURL }); }).then(() => { console.log('Profile picture saved to database.'); }); }); });

            function updateGauge(hashRate) {
                if (gaugeAnimationInterval) clearInterval(gaugeAnimationInterval);
                gaugeAnimationInterval = setInterval(() => {
                    const fluctuation = (Math.random() - 0.5) * (hashRate * 0.20); 
                    const currentDisplayRate = Math.max(0, hashRate + fluctuation);
                    const maxPossibleHashRate = 100; const percentage = (currentDisplayRate / maxPossibleHashRate) * 100;
                    const value = Math.max(0, Math.min(100, percentage)); const valueStr = value.toFixed(2); 
                    const [integerPart, decimalPart] = valueStr.split('.'); 
                    document.getElementById('gauge-value-int').textContent = integerPart; document.getElementById('gauge-value-dec').textContent = decimalPart; 
                    document.getElementById('hash-rate-value').textContent = currentDisplayRate.toFixed(2);
                    const progressAngle = (value / 100) * 270; 
                    document.querySelector('#booster-page .gauge-progress').style.background = `conic-gradient(from 135deg, #FF8C00, #FFD700 35%, #34C759 ${progressAngle}deg, #3a3a3c ${progressAngle}deg, #3a3a3c 270deg, transparent 270deg)`; 
                }, 1000);
            }
            function createGaugeScale() { const scaleContainer = document.querySelector('#booster-page .gauge-scale'); if (!scaleContainer || scaleContainer.innerHTML !== '') return; for (let i = 0; i < 30; i++) { const angle = 135 + (i / 29) * 270; const segment = document.createElement('div'); segment.className = 'gauge-tick-segment'; segment.style.transform = `translateX(-50%) translateY(-50%) rotate(${angle}deg) translate(0, -160px)`; scaleContainer.appendChild(segment); } for (let i = 0; i < 11; i++) { const percent = i * 10; const angle = 135 + (i / 10) * 270; const label = document.createElement('div'); label.className = 'gauge-label'; label.textContent = `${percent}%`; const labelX = 175 + 115 * Math.cos((angle - 90) * Math.PI / 180); const labelY = 175 + 115 * Math.sin((angle - 90) * Math.PI / 180); label.style.left = `${labelX}px`; label.style.top = `${labelY}px`; label.style.transform = 'translate(-50%, -50%)'; scaleContainer.appendChild(label); } };
            
            // --- MODIFIED NAVIGATION LOGIC ---
            const navItems = document.querySelectorAll('.new-nav-item, .nav-center-button');
            const pages = document.querySelectorAll('.page');
            const profilePicBtn = document.getElementById('profile-pic-btn');
            function showPage(pageId) { 
                pages.forEach(page => page.classList.remove('active')); 
                const activePage = document.getElementById(pageId); 
                if (activePage) activePage.classList.add('active'); 
                navItems.forEach(item => { item.classList.toggle('active', item.getAttribute('data-page') === pageId); }); 
                if (pageId === 'history-page' && auth.currentUser) { loadTransactionHistory(auth.currentUser); } 
            }
            navItems.forEach(item => { item.addEventListener('click', () => { const pageId = item.getAttribute('data-page'); showPage(pageId); }); });
            profilePicBtn.addEventListener('click', () => showPage('profile-page')); 
            showPage('dashboard-page');

            
            const receivePage = document.getElementById('receive-page');
            const qrCodeElement = document.getElementById('qr-code-canvas');
            const qrCode = new QRCodeStyling({ width: 250, height: 250, type: 'svg', dotsOptions: { color: "#000000", type: "rounded" }, backgroundOptions: { color: "#ffffff" }, cornersSquareOptions: { type: "extra-rounded" }, cornersDotOptions: { type: "dot" }, imageOptions: { crossOrigin: "anonymous", margin: 8, imageSize: 0.4 }, });
            function showReceivePage() { if (!currentUserData || !currentUserData.blockchainAddress) { showToast('User data not loaded yet.', true); return; } document.getElementById('receive-page-address').textContent = currentUserData.blockchainAddress; qrCode.update({ data: currentUserData.blockchainAddress, image: currentUserData.photoURL || "" }); qrCode.append(qrCodeElement); receivePage.style.display = 'flex'; bottomNav.style.display = 'none'; }
            
            document.getElementById('receive-back-btn').addEventListener('click', () => { receivePage.style.display = 'none'; bottomNav.style.display = 'flex'; qrCodeElement.innerHTML = ''; });
            document.getElementById('receive-copy-btn').addEventListener('click', (e) => { navigator.clipboard.writeText(currentUserData.blockchainAddress).then(() => { showToast('Address copied!'); }); });

            // --- MODIFIED: HISTORY BACK BUTTON ---
            document.getElementById('history-back-btn').addEventListener('click', () => showPage('dashboard-page'));
            
            function loadTransactionHistory(user) {
                const transactionList = document.getElementById('transaction-list'), noTransactionsMessage = document.getElementById('no-transactions-message');
                const txRef = db.ref('transactions/' + user.uid).orderByChild('timestamp');
                if (txRefListener) txRef.off('value', txRefListener);
                txRefListener = txRef.on('value', (snapshot) => {
                    transactionList.innerHTML = ''; 
                    if (snapshot.exists()) {
                        noTransactionsMessage.style.display = 'none';
                        const transactionsArray = Object.values(snapshot.val()).sort((a, b) => b.timestamp - a.timestamp);
                        transactionsArray.forEach((tx, index) => {
                            const item = document.createElement('div'); item.className = `transaction-item ${tx.type}`; 
                            const formattedDate = new Date(tx.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                            let iconClass, sign, title;
                            // --- MODIFIED: ICONS ---
                            switch (tx.type) {
                                case 'sent': iconClass = 'fa-arrow-up-from-bracket'; sign = '-'; title = `Sent to ${tx.counterpartyName || 'user'}`; break;
                                case 'received': iconClass = 'fa-qrcode'; sign = '+'; title = `Received from ${tx.counterpartyName || 'user'}`; break;
                                case 'deposit': iconClass = 'fa-download'; sign = '+'; title = `Deposit via BTC`; break;
                                case 'withdraw': iconClass = 'fa-upload'; sign = '-'; title = `Withdrawal to BTC`; break;
                                case 'purchase': iconClass = 'fa-cart-shopping'; sign = '-'; title = `Purchased: ${tx.itemName}`; break;
                                case 'mining': iconClass = 'fa-solid fa-wallet'; sign = '+'; title = 'Mining Income'; break;
                                case 'upgrade': iconClass = 'fa-solid fa-circle-chevron-up'; sign = '-'; title = `Upgraded Miner`; break;
                                default: iconClass = 'fa-question'; sign = ''; title = 'Unknown Transaction';
                            }
                            const amountBTC = tx.amountBTC || 0; const amountUSD = tx.amountUSD || (amountBTC * btcPrice);
                            item.innerHTML = `<div class="icon"><i class="fa-solid ${iconClass}"></i></div><div class="details"><div class="title">${title}</div><div class="date">${formattedDate}</div></div><div class="amount"><div class="amount-btc">${sign}${amountBTC.toFixed(8)} BTC</div><div class="amount-usd">≈$${amountUSD.toFixed(2)}</div></div>`;
                            item.style.animationDelay = `${index * 0.05}s`;
                            transactionList.appendChild(item);
                        });
                    } else { noTransactionsMessage.style.display = 'block'; }
                });
            }

            // --- NEW: RECENT TRANSACTIONS ON DASHBOARD ---
            function populateRecentTransactions(userId) {
                const container = document.getElementById('recent-tx-list-container');
                db.ref('transactions/' + userId).orderByChild('timestamp').limitToLast(3).once('value', snapshot => {
                    container.innerHTML = '';
                    if (!snapshot.exists()) {
                        container.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">No recent transactions.</p>`;
                        return;
                    }
                    const transactions = [];
                    snapshot.forEach(child => { transactions.push(child.val()); });
                    transactions.reverse().forEach(tx => {
                        const item = document.createElement('div');
                        item.className = 'recent-tx-item';
                        const date = new Date(tx.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + new Date(tx.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const isPositive = ['received', 'deposit', 'mining'].includes(tx.type);
                        const amount = tx.amountUSD ? tx.amountUSD : (tx.amountBTC * btcPrice);
                        let title = tx.type;
                        if(tx.type === 'sent') title = tx.counterpartyName || 'Sent';
                        if(tx.type === 'received') title = tx.counterpartyName || 'Received';
                        if(tx.type === 'purchase') title = tx.itemName || 'Purchase';

                        item.innerHTML = `
                            <div class="icon" style="background-color: ${isPositive ? 'rgba(39, 199, 137, 0.15)' : 'rgba(255, 69, 58, 0.15)'};">
                                <i class="fa-solid ${isPositive ? 'fa-arrow-down' : 'fa-arrow-up'}" style="color: ${isPositive ? 'var(--primary-green)' : 'var(--text-negative)'};"></i>
                            </div>
                            <div class="details">
                                <div class="title">${title.charAt(0).toUpperCase() + title.slice(1)}</div>
                                <div class="date">${date}</div>
                            </div>
                            <div class="amount ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : '-'}$${amount.toFixed(2)}
                            </div>
                        `;
                        container.appendChild(item);
                    });
                });
            }
            document.getElementById('recent-tx-see-more').addEventListener('click', () => showPage('history-page'));


            const qrScanBtn = document.getElementById("qr-scan-btn"), qrScannerOverlay = document.getElementById("qr-scanner-overlay"), closeScannerBtn = document.getElementById("close-scanner-btn"), video = document.getElementById("qr-video"), canvasElement = document.getElementById("qr-canvas"), canvas = canvasElement.getContext("2d"), permissionMessage = document.getElementById("permission-message"), qrFileInput = document.getElementById("qr-file-input");
            let stream, animationFrameId;
            document.getElementById("refresh-btn").addEventListener("click", function() { location.reload() });
            function stopCamera() { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } if (stream) { stream.getTracks().forEach(track => track.stop()); } qrScannerOverlay.style.display = "none"; video.style.display = "none"; }
            async function validateAndInitiateSend(address) { loadingOverlay.style.display = 'flex'; try { const snapshot = await db.ref('users').orderByChild('blockchainAddress').equalTo(address).once('value'); if (snapshot.exists()) { openSendFlow(); showRecipientInfo(snapshot); } else { showToast("Address not found in our system.", true); } } catch (error) { showToast("Error validating address.", true); } finally { loadingOverlay.style.display = 'none'; } }
            function tick() { if (video.readyState === video.HAVE_ENOUGH_DATA) { canvasElement.height = video.videoHeight; canvasElement.width = video.videoWidth; canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height); const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height); const code = jsQR(imageData.data, imageData.width, imageData.height); if (code) { stopCamera(); validateAndInitiateSend(code.data); return; } } if (qrScannerOverlay.style.display === "flex") { animationFrameId = requestAnimationFrame(tick); } }
            
            function startQrScanner() {
                if (!currentUserData.sendUnlocked) { showToast('Please purchase a miner to unlock this feature.', true); return; }
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { qrScannerOverlay.style.display = "flex"; permissionMessage.style.display = "none"; video.style.display = "block"; navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(s) { stream = s; video.srcObject = stream; video.play(); animationFrameId = requestAnimationFrame(tick); }).catch(function(err) { video.style.display = "none"; if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") { permissionMessage.textContent = "Camera access was denied."; } else { permissionMessage.textContent = "Failed to start the camera."; } permissionMessage.style.display = "block"; }); } else { permissionMessage.textContent = "Camera is not supported."; permissionMessage.style.display = "block"; qrScannerOverlay.style.display = "flex"; }
            }
            
            qrScanBtn.addEventListener("click", startQrScanner);
            document.getElementById('qr-scan-btn-inline').addEventListener('click', startQrScanner);
            closeScannerBtn.addEventListener("click", stopCamera);
            qrFileInput.addEventListener("change", e => { const file = e.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.onload = function() { canvasElement.width = img.width; canvasElement.height = img.height; canvas.drawImage(img, 0, 0, img.width, img.height); const imageData = canvas.getImageData(0, 0, img.width, img.height); const code = jsQR(imageData.data, imageData.width, imageData.height); if (code) { stopCamera(); validateAndInitiateSend(code.data); } else { showToast("No QR Code found.", true); } }; img.src = event.target.result; }; reader.readAsDataURL(file); });
            
            function showFlowStep(flowPage, stepId) { flowPage.querySelectorAll('.flow-step').forEach(s => s.classList.remove('active')); const activeStep = flowPage.querySelector(`#${stepId}`); if(activeStep) activeStep.classList.add('active'); }
            const sendFlowPage = document.getElementById('send-flow-page'), recipientInput = document.getElementById('recipient-address-input'), clearScannedAddressBtn = document.getElementById('clear-scanned-address-btn'), recipientInfoDisplay = document.getElementById('recipient-info-display');
            
            function openSendFlow() {
                if (!currentUserData.sendUnlocked) { showToast('Please purchase a miner to unlock this feature.', true); return; }
                sendFlowPage.style.display = 'flex'; bottomNav.style.display = 'none'; 
                showFlowStep(sendFlowPage, 'send-amount-step'); 
            }

            let sendState = { recipientAddress: '', recipientUID: null, recipientName: '', amountUSD: 0, amountBTC: 0, amountString: '0' }; let isInputInUSD = false; 
            
            function resetSendFlow() { 
                sendState = { recipientAddress: '', recipientUID: null, recipientName: '', amountUSD: 0, amountBTC: 0, amountString: '0' }; 
                isInputInUSD = false; 
                numericInput.value = ''; 
                document.getElementById('address-error-msg').textContent = ''; 
                updateSendCurrencyUI(); 
                recalculateValuesAndUI(); 
                sendFlowPage.style.display = 'none'; 
                bottomNav.style.display = 'flex'; 
                resetSwipeUI(document.getElementById('send-swipe-thumb'), document.getElementById('send-swipe-track-fill'), document.getElementById('send-swipe-text'));
                
                // Reset recipient UI
                recipientInfoDisplay.style.display = 'none';
                recipientInput.style.display = 'block';
                recipientInput.value = '';
                document.querySelector('.qr-scan-btn-inline').style.display = 'flex';
            }
            
            document.getElementById('amount-back-btn').addEventListener('click', resetSendFlow);
            
            clearScannedAddressBtn.addEventListener('click', () => { 
                recipientInfoDisplay.style.display = 'none';
                recipientInput.style.display = 'block';
                recipientInput.value = '';
                sendState.recipientAddress = '';
                sendState.recipientUID = null;
                sendState.recipientName = '';
                document.querySelector('.qr-scan-btn-inline').style.display = 'flex';
                recalculateValuesAndUI(); 
            });

            const numericInput = document.getElementById('numeric-amount-input'), amountDisplay = document.getElementById('send-amount-display'), amountCursor = document.getElementById('amount-cursor'), currencyUnit = document.getElementById('send-currency-unit'), equivalentDisplay = document.getElementById('send-amount-equivalent'), amountNextBtn = document.getElementById('send-amount-next-btn'), currencyToggleBtn = document.getElementById('currency-toggle-btn'), limitErrorMsg = document.getElementById('limit-error-msg');
            document.getElementById('amount-input-area').addEventListener('click', () => numericInput.focus());
            numericInput.addEventListener('focus', () => { amountCursor.style.display = 'inline-block'; });
            numericInput.addEventListener('blur', () => { amountCursor.style.display = 'none'; });
            currencyToggleBtn.addEventListener('click', () => { isInputInUSD = !isInputInUSD; sendState.amountString = '0'; numericInput.value = ''; updateSendCurrencyUI(); recalculateValuesAndUI(); });
            function updateSendCurrencyUI() { currencyUnit.textContent = isInputInUSD ? "USD" : "BTC"; }
            numericInput.addEventListener('input', (e) => { 
                let rawValue = e.target.value.replace(/[^0-9.]/g, '');
                if ((rawValue.match(/\./g) || []).length > 2) rawValue = rawValue.substring(0, rawValue.lastIndexOf('.'));
                sendState.amountString = rawValue || '0'; numericInput.value = rawValue;
                recalculateValuesAndUI(); 
            });
            
            function showRecipientInfo(snapshot) {
                const recipientData = snapshot.val();
                const recipientUID = Object.keys(recipientData)[0];
                const recipient = recipientData[recipientUID];
                
                sendState.recipientAddress = recipient.blockchainAddress;
                sendState.recipientUID = recipientUID;
                sendState.recipientName = recipient.name;

                document.getElementById('recipient-info-pic').src = recipient.photoURL || DEFAULT_PROFILE_PIC;
                document.getElementById('recipient-info-name').textContent = recipient.name;
                document.getElementById('recipient-info-address').textContent = `${recipient.blockchainAddress.substring(0, 10)}...`;
                
                recipientInput.style.display = 'none';
                recipientInfoDisplay.style.display = 'flex';
                document.querySelector('.qr-scan-btn-inline').style.display = 'none';
                recalculateValuesAndUI();
            }
            
            // --- NEW: Function to prefill send flow from Quick Transfer
            function prefillSendFlow(contactData) {
                openSendFlow();
                const snapshot = { val: () => ({ [contactData.uid]: contactData }) };
                showRecipientInfo(snapshot);
            }

            async function validateAddress(address) {
                const addressErrorMsg = document.getElementById('address-error-msg');
                addressErrorMsg.textContent = '';
                if (address.trim().length < 26) { return; }
                if (address === currentUserData.blockchainAddress) { 
                    addressErrorMsg.textContent = "You cannot send to your own address.";
                    return; 
                }

                try {
                    const snapshot = await db.ref('users').orderByChild('blockchainAddress').equalTo(address).once('value');
                    if (snapshot.exists()) {
                        showRecipientInfo(snapshot);
                    } else {
                        addressErrorMsg.textContent = "User with this address not found.";
                    }
                } catch (error) {
                    addressErrorMsg.textContent = "Error checking address. Please try again.";
                }
            }
            
            recipientInput.addEventListener('blur', () => validateAddress(recipientInput.value));
            
            function recalculateValuesAndUI() { 
                const value = parseFloat(sendState.amountString) || 0; 
                if (isInputInUSD) { sendState.amountUSD = value; sendState.amountBTC = value / btcPrice; } 
                else { sendState.amountBTC = value; sendState.amountUSD = value * btcPrice; } 
                
                const isZero = sendState.amountString === '0' || sendState.amountString === '';
                amountDisplay.classList.toggle('placeholder', isZero);
                amountDisplay.textContent = isZero ? '0' : sendState.amountString;
                if (isInputInUSD) { equivalentDisplay.textContent = `~${sendState.amountBTC.toFixed(8)} BTC`; } 
                else { equivalentDisplay.textContent = `~$${sendState.amountUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
                
                const hasSufficientBalance = sendState.amountBTC <= currentUserData.btcBalance;
                const exceedsLimit = sendState.amountUSD > SEND_LIMIT_USD;
                const belowMinLimit = sendState.amountUSD > 0 && sendState.amountUSD < MIN_SEND_USD;
                limitErrorMsg.textContent = '';
                if (exceedsLimit) { limitErrorMsg.textContent = `Limit: ${SEND_LIMIT_USD.toLocaleString('en-US', {style:'currency', currency:'USD'})} per transaction`; } 
                else if (belowMinLimit) { limitErrorMsg.textContent = `Minimum send amount is $${MIN_SEND_USD}.`; }
                
                amountNextBtn.disabled = !hasSufficientBalance || sendState.amountBTC <= 0 || !sendState.recipientUID || exceedsLimit || belowMinLimit;
            }

            document.getElementById('send-max-btn').addEventListener('click', () => { const maxAllowedBTC = SEND_LIMIT_USD / btcPrice; const maxAmount = Math.min(currentUserData.btcBalance || 0, maxAllowedBTC); if (isInputInUSD) { sendState.amountString = (maxAmount * btcPrice).toFixed(2); } else { sendState.amountString = maxAmount.toFixed(8); } numericInput.value = sendState.amountString; recalculateValuesAndUI(); });
            
            amountNextBtn.addEventListener('click', () => { 
                const amount = sendState.amountBTC, fee = amount * 0.02, received = amount - fee; 
                document.getElementById('confirm-recipient').innerHTML = `${sendState.recipientName} <span class="value-secondary">${sendState.recipientAddress.substring(0,8)}...</span>`; 
                document.getElementById('confirm-amount-sent').innerHTML = `${amount.toFixed(8)} BTC <span class="value-secondary">~$${(amount * btcPrice).toFixed(2)}</span>`; 
                document.getElementById('confirm-fee').innerHTML = `${fee.toFixed(8)} BTC <span class="value-secondary">~$${(fee * btcPrice).toFixed(2)}</span>`; 
                document.getElementById('confirm-amount-received').innerHTML = `${received.toFixed(8)} BTC <span class="value-secondary">~$${(received * btcPrice).toFixed(2)}</span>`; 
                showFlowStep(sendFlowPage, 'send-confirmation-step'); 
            });
            
            document.getElementById('confirm-back-btn').addEventListener('click', () => showFlowStep(sendFlowPage, 'send-amount-step'));
            function processTransaction() { loadingOverlay.style.display = 'flex'; const totalDeducted = sendState.amountBTC, amountReceived = totalDeducted * 0.98; const txId = 'tx_' + new Date().getTime() + Math.random().toString(36).substr(2, 9), timestamp = firebase.database.ServerValue.TIMESTAMP; const senderTxData = { type: 'sent', amountBTC: totalDeducted, amountUSD: totalDeducted * btcPrice, counterpartyName: sendState.recipientName, counterpartyAddress: sendState.recipientAddress, status: 'completed', timestamp }; const receiverTxData = { type: 'received', amountBTC: amountReceived, amountUSD: amountReceived * btcPrice, counterpartyName: currentUserData.name, counterpartyAddress: currentUserData.blockchainAddress, status: 'completed', timestamp }; const updates = {}; updates[`users/${sendState.recipientUID}/btcBalance`] = firebase.database.ServerValue.increment(amountReceived); updates[`users/${currentUserData.uid}/btcBalance`] = firebase.database.ServerValue.increment(-totalDeducted); updates[`transactions/${currentUserData.uid}/${txId}`] = senderTxData; updates[`transactions/${sendState.recipientUID}/${txId}`] = receiverTxData; db.ref().update(updates).then(() => { loadingOverlay.style.display = 'none'; document.getElementById('success-amount-sent').textContent = `${totalDeducted.toFixed(8)} BTC`; document.getElementById('success-recipient').textContent = sendState.recipientName; document.getElementById('success-time').textContent = new Date().toLocaleTimeString(); document.getElementById('success-txid').textContent = `${txId.substring(0, 12)}...`; showFlowStep(sendFlowPage, 'send-success-step'); const animIcon = document.querySelector('.btc-animation-icon'); animIcon.style.animation = 'none'; void animIcon.offsetWidth; animIcon.style.animation = 'send-btc-animation 2s forwards'; }).catch(error => { loadingOverlay.style.display = 'none'; showToast("Transaction failed: " + error.message, true); resetSendFlow(); }); }
            document.getElementById('send-done-btn').addEventListener('click', resetSendFlow);

            const fundFlowPage = document.getElementById('fund-flow-page');
            function openFundFlow() { fundFlowPage.style.display = 'flex'; bottomNav.style.display = 'none'; showFlowStep(fundFlowPage, 'fund-choice-step'); document.getElementById('deposit-address').textContent = adminSettings.depositAddress || "Not Set"; document.getElementById('deposit-qr-image').src = adminSettings.depositQrUrl || ""; }
            function resetFundFlow() { fundFlowPage.style.display = 'none'; bottomNav.style.display = 'flex'; document.getElementById('deposit-amount-usd').value = ''; document.getElementById('deposit-txid').value = ''; document.getElementById('withdraw-amount-usd').value = ''; document.getElementById('withdraw-btc-address').value = ''; document.getElementById('withdraw-password').value = ''; resetSwipeUI(document.getElementById('deposit-swipe-thumb'), document.getElementById('deposit-swipe-track-fill'), document.getElementById('deposit-swipe-text')); resetSwipeUI(document.getElementById('withdraw-swipe-thumb'), document.getElementById('withdraw-swipe-track-fill'), document.getElementById('withdraw-swipe-text')); }
            document.getElementById('fund-choice-back-btn').addEventListener('click', resetFundFlow);
            document.getElementById('go-to-deposit-btn').addEventListener('click', () => showFlowStep(fundFlowPage, 'fund-deposit-step'));
            document.getElementById('go-to-withdraw-btn').addEventListener('click', () => showFlowStep(fundFlowPage, 'fund-withdraw-step'));
            document.getElementById('deposit-back-btn').addEventListener('click', () => showFlowStep(fundFlowPage, 'fund-choice-step'));
            document.getElementById('withdraw-back-btn').addEventListener('click', () => showFlowStep(fundFlowPage, 'fund-choice-step'));
            document.getElementById('fund-done-btn').addEventListener('click', resetFundFlow);
            document.getElementById('deposit-copy-address-btn').addEventListener('click', () => { if(adminSettings.depositAddress) navigator.clipboard.writeText(adminSettings.depositAddress).then(() => showToast('Deposit address copied!')); });
            
            // --- MODIFIED: REMOVED SCREENSHOT LOGIC ---
            async function submitDepositRequest() { const amountUSD = parseFloat(document.getElementById('deposit-amount-usd').value), txid = document.getElementById('deposit-txid').value.trim(); if (isNaN(amountUSD) || amountUSD < MIN_DEPOSIT_USD) { showToast(`Minimum deposit is $${MIN_DEPOSIT_USD}.`, true); resetSwipeUI(document.getElementById('deposit-swipe-thumb'), document.getElementById('deposit-swipe-track-fill'), document.getElementById('deposit-swipe-text')); return; } if (!txid) { showToast('Please provide a Transaction ID.', true); resetSwipeUI(document.getElementById('deposit-swipe-thumb'), document.getElementById('deposit-swipe-track-fill'), document.getElementById('deposit-swipe-text')); return; } loadingOverlay.style.display = 'flex'; try { const requestData = { type: 'deposit', amountUSD, txid, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP, userId: auth.currentUser.uid, userName: currentUserData.name, userEmail: currentUserData.email }; const newRequestRef = db.ref(`requests/${auth.currentUser.uid}`).push(); await newRequestRef.set(requestData); document.getElementById('fund-status-icon').className = 'fa-solid fa-hourglass-half fa-spin'; document.getElementById('fund-status-icon').style.color = 'var(--primary-orange)'; document.getElementById('fund-status-title').textContent = 'Request Submitted!'; document.getElementById('fund-status-message').textContent = `Your deposit request for $${amountUSD.toFixed(2)} is now under review.`; showFlowStep(fundFlowPage, 'fund-status-step'); } catch (error) { showToast('Failed to submit request: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; } }
            
            async function submitWithdrawRequest() { const amountUSD = parseFloat(document.getElementById('withdraw-amount-usd').value), recipientAddress = document.getElementById('withdraw-btc-address').value.trim(), password = document.getElementById('withdraw-password').value, amountBTC = amountUSD / btcPrice, user = auth.currentUser; const resetSwipe = () => resetSwipeUI(document.getElementById('withdraw-swipe-thumb'), document.getElementById('withdraw-swipe-track-fill'), document.getElementById('withdraw-swipe-text')); if (isNaN(amountUSD) || amountUSD < MIN_WITHDRAW_USD) { showToast(`Minimum withdrawal is $${MIN_WITHDRAW_USD}.`, true); resetSwipe(); return; } if (!recipientAddress || recipientAddress.length < 26) { showToast('Please enter a valid BTC address.', true); resetSwipe(); return; } if (amountBTC > (currentUserData.btcBalance || 0)) { showToast('Insufficient balance for this withdrawal.', true); resetSwipe(); return; } if (!password) { showToast('Please enter your password to confirm.', true); resetSwipe(); return; } loadingOverlay.style.display = 'flex'; try { const credential = firebase.auth.EmailAuthProvider.credential(user.email, password); await user.reauthenticateWithCredential(credential); const requestData = { type: 'withdraw', amountUSD, amountBTC, recipientAddress, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP, userId: user.uid, userName: currentUserData.name, userEmail: currentUserData.email }; const newRequestRef = db.ref(`requests/${user.uid}`).push(); await newRequestRef.set(requestData); document.getElementById('fund-status-icon').className = 'fa-solid fa-hourglass-half fa-spin'; document.getElementById('fund-status-icon').style.color = 'var(--primary-orange)'; document.getElementById('fund-status-title').textContent = 'Withdrawal Requested!'; document.getElementById('fund-status-message').textContent = `Your withdrawal request for $${amountUSD.toFixed(2)} is being processed.`; showFlowStep(fundFlowPage, 'fund-status-step'); } catch(error) { if (error.code === 'auth/wrong-password') { showToast('Incorrect password. Please try again.', true); } else { showToast('Authentication failed: ' + error.message, true); } resetSwipe(); } finally { loadingOverlay.style.display = 'none'; } }
            
            function setupSwipe(thumbId, containerId, trackFillId, textId, onConfirm) { const swipeThumb = document.getElementById(thumbId), swipeContainer = document.getElementById(containerId), swipeText = document.getElementById(textId), swipeTrackFill = document.getElementById(trackFillId); let isSwiping = false, startX, maxSwipe; function onSwipeStart(e) { e.preventDefault(); isSwiping = true; startX = e.clientX || e.touches[0].clientX; maxSwipe = swipeContainer.clientWidth - swipeThumb.clientWidth - 16; swipeThumb.classList.add('swiping'); swipeThumb.style.transition = 'transform 0.1s linear'; swipeTrackFill.style.transition = 'width 0.1s linear'; } function onSwipeMove(e) { if (!isSwiping) return; const currentX = e.clientX || e.touches[0].clientX; let diffX = Math.min(Math.max(0, currentX - startX), maxSwipe); swipeThumb.style.transform = `translateX(${diffX}px)`; swipeTrackFill.style.width = `${64 + diffX}px`; swipeText.style.opacity = 1 - (diffX / maxSwipe) * 2; } function onSwipeEnd() { if (!isSwiping) return; isSwiping = false; swipeThumb.classList.remove('swiping'); const currentTranslateX = new DOMMatrix(getComputedStyle(swipeThumb).transform).m41; if (currentTranslateX >= maxSwipe * 0.95) { onConfirm(); } else { resetSwipeUI(swipeThumb, swipeTrackFill, swipeText); } } swipeThumb.addEventListener('mousedown', onSwipeStart); document.addEventListener('mousemove', onSwipeMove); document.addEventListener('mouseup', onSwipeEnd); swipeThumb.addEventListener('touchstart', onSwipeStart, { passive: false }); document.addEventListener('touchmove', onSwipeMove); document.addEventListener('touchend', onSwipeEnd); }
            function resetSwipeUI(thumb, trackFill, text) { thumb.style.transition = 'transform 0.3s ease'; trackFill.style.transition = 'width 0.3s ease'; text.style.transition = 'opacity 0.3s ease'; thumb.style.transform = `translateX(0px)`; trackFill.style.width = `64px`; text.style.opacity = 1; setTimeout(() => { thumb.style.transition = 'transform 0.1s linear'; trackFill.style.transition = 'width 0.1s linear'; text.style.transition = ''; }, 300); }
            setupSwipe('send-swipe-thumb', 'send-swipe-container', 'send-swipe-track-fill', 'send-swipe-text', processTransaction); setupSwipe('deposit-swipe-thumb', 'deposit-swipe-container', 'deposit-swipe-track-fill', 'deposit-swipe-text', submitDepositRequest); setupSwipe('withdraw-swipe-thumb', 'withdraw-swipe-container', 'withdraw-swipe-track-fill', 'withdraw-swipe-text', submitWithdrawRequest);

            // --- NEW: Add Contact Logic ---
            const addContactModal = document.getElementById('add-contact-modal');
            const addContactBtn = document.getElementById('add-contact-btn');
            const closeContactModalBtn = document.getElementById('close-contact-modal-btn');
            const addContactStep1 = document.getElementById('add-contact-step1');
            const addContactStep2 = document.getElementById('add-contact-step2');
            const addContactNextBtn = document.getElementById('add-contact-next-btn');
            const addContactBackBtn = document.getElementById('add-contact-back-btn');
            
            function resetAddContactModal() {
                addContactModal.style.display = 'none';
                document.getElementById('add-contact-address-input').value = '';
                addContactStep1.classList.add('active');
                addContactStep2.classList.remove('active');
                contactToAdd = null;
                resetSwipeUI(document.getElementById('add-contact-swipe-thumb'), document.getElementById('add-contact-swipe-track-fill'), document.getElementById('add-contact-swipe-text'));
            }

            addContactBtn.addEventListener('click', () => {
                addContactModal.style.display = 'flex';
            });
            closeContactModalBtn.addEventListener('click', resetAddContactModal);
            addContactBackBtn.addEventListener('click', () => {
                addContactStep1.classList.add('active');
                addContactStep2.classList.remove('active');
                contactToAdd = null;
            });

            addContactNextBtn.addEventListener('click', async () => {
                const address = document.getElementById('add-contact-address-input').value.trim();
                if(!address) {
                    showToast("Please enter an address.", true);
                    return;
                }
                loadingOverlay.style.display = 'flex';
                try {
                    const snapshot = await db.ref('users').orderByChild('blockchainAddress').equalTo(address).once('value');
                    if (snapshot.exists()) {
                        const uid = Object.keys(snapshot.val())[0];
                        const userData = snapshot.val()[uid];
                        contactToAdd = { uid, ...userData };

                        document.getElementById('confirm-contact-pic').src = userData.photoURL || DEFAULT_PROFILE_PIC;
                        document.getElementById('confirm-contact-name').textContent = userData.name;
                        document.getElementById('confirm-contact-address').textContent = userData.blockchainAddress;

                        addContactStep1.classList.remove('active');
                        addContactStep2.classList.add('active');

                    } else {
                        showToast("User with this address not found.", true);
                    }
                } catch (error) {
                    showToast("Error finding user. Please try again.", true);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            });

            function confirmAddContact() {
                if (!contactToAdd || !auth.currentUser) return;
                const user = auth.currentUser;
                db.ref(`users/${user.uid}/quickContacts/${contactToAdd.uid}`).set(true)
                .then(() => {
                    showToast(`${contactToAdd.name} added to quick transfer!`);
                    resetAddContactModal();
                })
                .catch(err => {
                    showToast("Failed to add contact.", true);
                    resetAddContactModal();
                });
            }
            setupSwipe('add-contact-swipe-thumb', 'add-contact-swipe-container', 'add-contact-swipe-track-fill', 'add-contact-swipe-text', confirmAddContact);

            async function populateQuickTransfer(contactUids) {
                const container = document.getElementById('quick-transfer-list-container');
                // Clear existing contacts but keep the add button
                container.innerHTML = `<div class="add-contact-btn" id="add-contact-btn"><i class="fa-solid fa-plus"></i></div>`;
                document.getElementById('add-contact-btn').addEventListener('click', () => addContactModal.style.display = 'flex'); // Re-attach listener

                if (!contactUids) return;

                const uids = Object.keys(contactUids);
                for (const uid of uids) {
                    const userSnap = await db.ref(`users/${uid}`).once('value');
                    if (userSnap.exists()) {
                        const userData = { uid, ...userSnap.val() };
                        const bubble = document.createElement('div');
                        bubble.className = 'contact-bubble';
                        bubble.innerHTML = `<img src="${userData.photoURL || DEFAULT_PROFILE_PIC}" alt="Contact">`;
                        bubble.addEventListener('click', () => prefillSendFlow(userData));
                        container.appendChild(bubble);
                    }
                }
            }


            const applyView = document.getElementById('community-apply-view'), displayView = document.getElementById('community-display-view'), applyBtn = document.getElementById('apply-community-btn'), referralCodeEl = document.getElementById('referral-code-text');
            function generateReferralCode() { const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789'; let code = ''; for (let i = 0; i < 8; i++) { code += chars.charAt(Math.floor(Math.random() * chars.length)); } return code; }
            function updateCommunityUI(data) { if (data.communityStatus === 'approved' && data.referralCode) { referralCodeEl.textContent = data.referralCode; displayView.style.display = 'block'; applyView.style.display = 'none'; populateLevels(data.referralLevels || {}); } else { applyView.style.display = 'block'; displayView.style.display = 'none'; } }
            function populateLevels(levelsData) { const container = document.getElementById('levels-list-container'); container.innerHTML = ''; const rates = [5, 3, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1]; for (let i = 1; i <= 12; i++) { const levelData = levelsData[`level${i}`] || { users: 0, earnings: 0 }; const card = document.createElement('div'); card.className = 'level-card'; card.dataset.level = i; card.innerHTML = `<div class="level-header"><h4>Level ${i}</h4><span class="commission-rate">${rates[i-1]}% Commission</span></div><div class="level-stats"><div class="stat-item"><span class="label">Users</span><span class="value">${levelData.users}</span></div><div class="stat-item"><span class="label">Earnings</span><span class="value">$${(levelData.earnings || 0).toFixed(2)}</span></div></div>`; container.appendChild(card); } document.querySelectorAll('.level-card').forEach(card => card.addEventListener('click', () => showLevelDetails(card.dataset.level))); }
            applyBtn.addEventListener('click', () => { const user = auth.currentUser; if (!user) return; applyBtn.disabled = true; applyBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Applying...`; setTimeout(() => { const newCode = generateReferralCode(); db.ref('users/' + user.uid).update({ communityStatus: 'approved', referralCode: newCode }).then(() => showToast('Application approved! Your community is active.')).catch(err => showToast('An error occurred: ' + err.message, true)).finally(() => { applyBtn.disabled = false; applyBtn.textContent = 'Apply Now'; }); }, 1500); });
            document.getElementById('copy-referral-btn').addEventListener('click', () => { const code = referralCodeEl.textContent; if(code) navigator.clipboard.writeText(code).then(() => showToast('Referral code copied!')); });
            document.getElementById('swap-commission-btn').addEventListener('click', () => { const user = auth.currentUser; if (!user || !currentUserData.commissionBalance || currentUserData.commissionBalance <= 0) { showToast('No commission balance to swap.', true); return; } const amountToSwap = currentUserData.commissionBalance; db.ref('users/' + user.uid).update({ commissionBalance: 0, btcBalance: firebase.database.ServerValue.increment(amountToSwap / btcPrice) }).then(() => showToast(`$${amountToSwap.toFixed(2)} swapped to main balance!`)).catch(err => showToast('Swap failed: ' + err.message, true)); });

            // --- NEW: LEVEL DETAILS PAGE LOGIC ---
            document.getElementById('level-details-back-btn').addEventListener('click', () => showPage('community-page'));
            
            async function getDownlineUids(startUids, level) {
                if (level <= 0 || startUids.length === 0) return startUids;
                const snapshot = await db.ref('users').orderByChild('referredBy').startAt(startUids[0]).endAt(startUids[startUids.length - 1]).once('value');
                const nextLevelUids = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        if (startUids.includes(childSnapshot.val().referredBy)) {
                            nextLevelUids.push(childSnapshot.key);
                        }
                    });
                }
                return getDownlineUids(nextLevelUids, level - 1);
            }

            async function showLevelDetails(level) {
                showPage('level-details-page');
                const listContainer = document.getElementById('level-user-list');
                const noUsersMessage = document.getElementById('no-level-users-message');
                listContainer.innerHTML = '';
                noUsersMessage.style.display = 'none';
                document.getElementById('level-details-title').textContent = `Level ${level} Users`;
                loadingOverlay.style.display = 'flex';

                try {
                    // This is an inefficient query but necessary without DB restructuring
                    let uidsToQuery = [auth.currentUser.uid];
                    for (let i = 0; i < level; i++) {
                        if(uidsToQuery.length === 0) break;
                        const promises = uidsToQuery.map(uid => db.ref('users').orderByChild('referredBy').equalTo(uid).once('value'));
                        const snapshots = await Promise.all(promises);
                        uidsToQuery = [];
                        snapshots.forEach(snapshot => {
                            if(snapshot.exists()){
                                uidsToQuery.push(...Object.keys(snapshot.val()));
                            }
                        });
                    }
                    
                    if (uidsToQuery.length > 0) {
                        const userDetailPromises = uidsToQuery.map(uid => db.ref(`users/${uid}`).once('value'));
                        const userSnapshots = await Promise.all(userDetailPromises);
                        const usersData = userSnapshots.map(snap => ({ uid: snap.key, ...snap.val() }));

                        usersData.forEach(userData => {
                            const item = document.createElement('div');
                            item.className = 'level-user-item';
                            item.dataset.name = userData.name.toLowerCase();
                            item.innerHTML = `
                                <img src="${userData.photoURL || DEFAULT_PROFILE_PIC}" alt="P">
                                <div class="info">
                                    <p class="name">${userData.name}</p>
                                    <p class="uid">${userData.uid.substring(0,15)}...</p>
                                </div>
                            `;
                            listContainer.appendChild(item);
                        });
                    } else {
                        noUsersMessage.style.display = 'block';
                    }
                } catch (error) {
                    showToast("Could not load level details.", true);
                    console.error("Error fetching level details:", error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            document.getElementById('level-user-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#level-user-list .level-user-item').forEach(item => {
                    const name = item.dataset.name || '';
                    item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
                });
            });

            function populateMarket() { const container = document.getElementById('market-list-container'); container.innerHTML = ''; if (Object.keys(minerProducts).length === 0) { container.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">Market is currently empty.</p>`; return; } const sortedProducts = Object.keys(minerProducts).map(key => ({ id: key, ...minerProducts[key] })).sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999)); sortedProducts.forEach(productData => { const product = productData, productId = productData.id, item = document.createElement('div'); item.className = 'market-list-item'; item.dataset.productId = productId; const discountedPrice = product.price * (1 - (product.discount || 0) / 100); let priceHtml = ''; if (product.discount > 0) { priceHtml = `<div class="discount-off-text">${product.discount}% OFF</div><div class="price-tag"><span class="original-price-struck">$${product.price.toFixed(0)}</span><span class="final-price-green">$${discountedPrice.toFixed(0)}</span></div>`; } else { priceHtml = `<div class="price-tag"><span class="final-price-green">$${product.price.toFixed(0)}</span></div>`; } item.innerHTML = `<div class="product-image-wrapper-new"><img src="${product.image}" alt="${product.name}"></div><div class="product-details-wrapper-new"><div class="stock-display">STUCK: ${product.stock}</div><h4>${product.name}</h4><p class="version-code">${product.versionCode}</p><p class="description">${product.description.substring(0, 30)}...</p><div class="price-wrapper-new">${priceHtml}</div></div>`; container.appendChild(item); }); document.querySelectorAll('.market-list-item').forEach(item => { item.addEventListener('click', (e) => { openProductDetails(e.currentTarget.dataset.productId); }); }); }
            const purchaseFlowPage = document.getElementById('purchase-flow-page'); let currentPurchase = { productId: null, quantity: 1, totalCostUSD: 0 };
            function openProductDetails(productId) { const product = minerProducts[productId]; if (!product || product.stock <= 0) { showToast("This item is out of stock.", true); return; } currentPurchase = { productId, quantity: 1, totalCostUSD: 0 }; document.getElementById('product-details-image').src = product.image; document.getElementById('product-details-name').textContent = product.name; document.getElementById('product-details-description').textContent = product.description; updatePurchaseQuantityAndPrice(); purchaseFlowPage.style.display = 'flex'; bottomNav.style.display = 'none'; showFlowStep(purchaseFlowPage, 'product-details-step'); }
            function updatePurchaseQuantityAndPrice() { const product = minerProducts[currentPurchase.productId], quantity = currentPurchase.quantity; document.getElementById('product-quantity').textContent = quantity; const discountedPrice = product.price * (1 - (product.discount || 0) / 100), originalPrice = product.price; currentPurchase.totalCostUSD = discountedPrice * quantity; document.getElementById('product-discounted-price').textContent = `$${currentPurchase.totalCostUSD.toFixed(2)}`; if (product.discount > 0) { document.getElementById('product-original-price').textContent = `$${(originalPrice * quantity).toFixed(2)}`; document.getElementById('product-original-price').style.display = 'inline'; } else { document.getElementById('product-original-price').style.display = 'none'; } }
            document.getElementById('quantity-plus-btn').addEventListener('click', () => { const product = minerProducts[currentPurchase.productId]; if(currentPurchase.quantity < product.stock) { currentPurchase.quantity++; updatePurchaseQuantityAndPrice(); } });
            document.getElementById('quantity-minus-btn').addEventListener('click', () => { if (currentPurchase.quantity > 1) { currentPurchase.quantity--; updatePurchaseQuantityAndPrice(); } });
            document.getElementById('product-details-back-btn').addEventListener('click', () => { purchaseFlowPage.style.display = 'none'; bottomNav.style.display = 'flex'; });
            document.getElementById('purchase-confirm-back-btn').addEventListener('click', () => { showFlowStep(purchaseFlowPage, 'product-details-step'); });
            document.getElementById('product-confirm-btn').addEventListener('click', () => { const totalCostBTC = currentPurchase.totalCostUSD / btcPrice; if (totalCostBTC > (currentUserData.btcBalance || 0)) { showToast('Insufficient balance for this purchase.', true); return; } const product = minerProducts[currentPurchase.productId]; document.getElementById('confirm-purchase-name').textContent = `${product.name} (x${currentPurchase.quantity})`; document.getElementById('confirm-purchase-quantity').textContent = currentPurchase.quantity; document.getElementById('confirm-purchase-cost').innerHTML = `${totalCostBTC.toFixed(8)} BTC <span class="value-secondary">~$${currentPurchase.totalCostUSD.toFixed(2)}</span>`; const balanceAfter = (currentUserData.btcBalance || 0) - totalCostBTC; document.getElementById('confirm-purchase-balance-after').innerHTML = `${balanceAfter.toFixed(8)} BTC <span class="value-secondary">~$${(balanceAfter * btcPrice).toFixed(2)}</span>`; showFlowStep(purchaseFlowPage, 'purchase-confirmation-step'); });
            const countPaidMiners = (miners) => Object.keys(miners || {}).filter(id => id !== FREE_MINER_ID).reduce((sum, id) => sum + (miners[id] || 0), 0);
            async function processPurchase() { const user = auth.currentUser; if (!user) return; loadingOverlay.style.display = 'flex'; const totalCostBTC = currentPurchase.totalCostUSD / btcPrice, product = minerProducts[currentPurchase.productId]; const updates = {}; const txId = 'purch_' + new Date().getTime(); updates[`/users/${user.uid}/btcBalance`] = firebase.database.ServerValue.increment(-totalCostBTC); updates[`/transactions/${user.uid}/${txId}`] = { type: 'purchase', itemName: `${product.name} (x${currentPurchase.quantity})`, amountBTC: totalCostBTC, amountUSD: currentPurchase.totalCostUSD, timestamp: firebase.database.ServerValue.TIMESTAMP }; updates[`/users/${user.uid}/purchasedMiners/${currentPurchase.productId}`] = firebase.database.ServerValue.increment(currentPurchase.quantity); updates[`/users/${user.uid}/activeDevices`] = firebase.database.ServerValue.increment(currentPurchase.quantity); updates[`/users/${user.uid}/totalHashRate`] = firebase.database.ServerValue.increment(product.hashRate * currentPurchase.quantity); updates[`/users/${user.uid}/sendUnlocked`] = true; updates[`/products/${currentPurchase.productId}/stock`] = firebase.database.ServerValue.increment(-currentPurchase.quantity); const hadPaidMinersBefore = countPaidMiners(currentUserData.purchasedMiners) > 0; if (currentUserData.referredBy && !hadPaidMinersBefore) { updates[`/users/${currentUserData.referredBy}/onlineUsers`] = firebase.database.ServerValue.increment(1); updates[`/users/${currentUserData.referredBy}/offlineUsers`] = firebase.database.ServerValue.increment(-1); } try { await db.ref().update(updates); showToast('Purchase successful!'); purchaseFlowPage.style.display = 'none'; bottomNav.style.display = 'flex'; showPage('dashboard-page'); } catch (error) { showToast('Purchase failed: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; resetSwipeUI(document.getElementById('purchase-swipe-thumb'), document.getElementById('purchase-swipe-track-fill'), document.getElementById('purchase-swipe-text')); } }
            setupSwipe('purchase-swipe-thumb', 'purchase-swipe-container', 'purchase-swipe-track-fill', 'purchase-swipe-text', processPurchase);
            
            document.getElementById('manage-miners-btn').addEventListener('click', () => showPage('my-miners-page'));
            document.getElementById('my-miners-back-btn').addEventListener('click', () => showPage('booster-page'));
            function populateMyMiners() { const container = document.getElementById('my-miner-list-container'), ownedMiners = currentUserData.purchasedMiners || {}; container.innerHTML = ''; const allPossibleMiners = {...minerProducts}; if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; } const hasMiners = Object.values(ownedMiners).some(qty => qty > 0); if (!hasMiners) { container.innerHTML = `<p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">You don't own any miners yet. Visit the Market to get started!</p>`; return; } for(const productId in ownedMiners) { const product = allPossibleMiners[productId]; if(product) { const quantity = ownedMiners[productId]; if (quantity <= 0) continue; const card = document.createElement('div'); card.className = 'my-miner-card-new'; card.innerHTML = `<div class="product-image-wrapper-new"><img src="${product.image}" alt="${product.name}"></div><div class="info"><h4>${product.name}</h4><p class="quantity">${quantity}x Owned</p><p class="stat"><i class="fa-solid fa-bolt"></i> ${product.hashRate} TH/s each</p></div><button class="upgrade-btn" data-product-id="${productId}" ${!product.upgradeToProductId ? 'disabled' : ''}>Upgrade</button>`; container.appendChild(card); } } document.querySelectorAll('.my-miner-card-new .upgrade-btn').forEach(btn => { btn.addEventListener('click', (e) => { openUpgradeDetails(e.target.dataset.productId); }); }); }
            let currentUpgrade = { fromId: null, toId: null, quantity: 1, maxQuantity: 0, totalCostUSD: 0 };
            function createProductCardHTML(product) { const discountedPrice = (product.price || 0) * (1 - (product.discount || 0) / 100); let priceHtml = `<div class="price-tag"><span class="final-price-green">${product.price ? '$'+discountedPrice.toFixed(0) : 'FREE'}</span></div>`; return `<div class="product-image-wrapper-new"><img src="${product.image}" alt="${product.name}"></div><div class="product-details-wrapper-new"><h4>${product.name}</h4><p class="version-code">${product.versionCode}</p><p class="description">${product.description.substring(0, 30)}...</p><div class="price-wrapper-new">${priceHtml}</div></div>`; }
            function openUpgradeDetails(fromProductId) { const allPossibleMiners = {...minerProducts}; if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; } const fromProduct = allPossibleMiners[fromProductId], toProduct = minerProducts[fromProduct.upgradeToProductId]; if (!fromProduct || !toProduct) { showToast('Upgrade path not available.', true); return; } const ownedCount = currentUserData.purchasedMiners[fromProductId]; currentUpgrade = { fromId: fromProductId, toId: fromProduct.upgradeToProductId, quantity: 1, maxQuantity: ownedCount, totalCostUSD: 0 }; document.getElementById('upgrade-from-card').innerHTML = createProductCardHTML(fromProduct); document.getElementById('upgrade-to-card').innerHTML = createProductCardHTML(toProduct); updateUpgradeQuantityAndPrice(); purchaseFlowPage.style.display = 'flex'; bottomNav.style.display = 'none'; showFlowStep(purchaseFlowPage, 'upgrade-details-step'); }
            function updateUpgradeQuantityAndPrice() { const allPossibleMiners = {...minerProducts}; if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; } const fromProduct = allPossibleMiners[currentUpgrade.fromId], toProduct = minerProducts[currentUpgrade.toId], quantity = 1; const tradeInValue = (fromProduct.price || 0) * 0.70; const newPrice = toProduct.price * (1 - (toProduct.discount || 0) / 100); currentUpgrade.totalCostUSD = (newPrice - tradeInValue) * quantity; document.getElementById('upgrade-cost').textContent = `$${currentUpgrade.totalCostUSD.toFixed(2)}`; }
            document.getElementById('upgrade-details-back-btn').addEventListener('click', () => { showPage('my-miners-page'); purchaseFlowPage.style.display = 'none'; bottomNav.style.display = 'flex'; });
            document.getElementById('upgrade-confirm-back-btn').addEventListener('click', () => { showFlowStep(purchaseFlowPage, 'upgrade-details-step'); });
            document.getElementById('upgrade-confirm-btn').addEventListener('click', () => { const totalCostBTC = currentUpgrade.totalCostUSD / btcPrice; if (totalCostBTC > (currentUserData.btcBalance || 0)) { showToast('Insufficient balance for this upgrade.', true); return; } const allPossibleMiners = {...minerProducts}; if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; } const fromProduct = allPossibleMiners[currentUpgrade.fromId], toProduct = minerProducts[currentUpgrade.toId]; document.getElementById('confirm-upgrade-action').textContent = `Upgrade 1x ${fromProduct.name} to ${toProduct.name}`; document.getElementById('confirm-upgrade-cost').innerHTML = `${totalCostBTC.toFixed(8)} BTC <span class="value-secondary">~$${currentUpgrade.totalCostUSD.toFixed(2)}</span>`; const balanceAfter = (currentUserData.btcBalance || 0) - totalCostBTC; document.getElementById('confirm-upgrade-balance-after').innerHTML = `${balanceAfter.toFixed(8)} BTC <span class="value-secondary">~$${(balanceAfter * btcPrice).toFixed(2)}</span>`; showFlowStep(purchaseFlowPage, 'upgrade-confirmation-step'); });
            async function processUpgrade() { const user = auth.currentUser; if (!user) return; loadingOverlay.style.display = 'flex'; const totalCostBTC = currentUpgrade.totalCostUSD / btcPrice, allPossibleMiners = {...minerProducts}; if(adminSettings.freeReferralMiner) { allPossibleMiners[FREE_MINER_ID] = adminSettings.freeReferralMiner; } const fromProduct = allPossibleMiners[currentUpgrade.fromId], toProduct = minerProducts[currentUpgrade.toId], quantity = 1; const updates = {}; const txId = 'upgrd_' + new Date().getTime(); updates[`/users/${user.uid}/btcBalance`] = firebase.database.ServerValue.increment(-totalCostBTC); updates[`/transactions/${user.uid}/${txId}`] = { type: 'upgrade', itemName: `${fromProduct.name} -> ${toProduct.name}`, amountBTC: totalCostBTC, amountUSD: currentUpgrade.totalCostUSD, timestamp: firebase.database.ServerValue.TIMESTAMP }; updates[`/users/${user.uid}/purchasedMiners/${currentUpgrade.fromId}`] = firebase.database.ServerValue.increment(-quantity); updates[`/users/${user.uid}/purchasedMiners/${currentUpgrade.toId}`] = firebase.database.ServerValue.increment(quantity); const hashRateChange = (toProduct.hashRate - fromProduct.hashRate) * quantity; updates[`/users/${user.uid}/totalHashRate`] = firebase.database.ServerValue.increment(hashRateChange); try { await db.ref().update(updates); showToast('Upgrade successful!'); purchaseFlowPage.style.display = 'none'; bottomNav.style.display = 'flex'; showPage('booster-page'); } catch (error) { showToast('Upgrade failed: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; resetSwipeUI(document.getElementById('upgrade-swipe-thumb'), document.getElementById('upgrade-swipe-track-fill'), document.getElementById('upgrade-swipe-text')); } }
            setupSwipe('upgrade-swipe-thumb', 'upgrade-swipe-container', 'upgrade-swipe-track-fill', 'upgrade-swipe-text', processUpgrade);

            function checkAndShowFreeMinerBanner() { const banner = document.getElementById('claim-miner-banner'); if (!adminSettings.freeReferralMinerEnabled || !currentUserData.referredBy || currentUserData.freeMinerClaimed) { banner.style.display = 'none'; return; } banner.style.display = 'block'; }
            document.getElementById('claim-miner-btn').addEventListener('click', async () => { const user = auth.currentUser, freeMiner = adminSettings.freeReferralMiner; if (!user || !freeMiner || !freeMiner.name) { showToast('Free miner offer is currently unavailable.', true); return; } loadingOverlay.style.display = 'flex'; const updates = {}; updates[`/users/${user.uid}/purchasedMiners/${FREE_MINER_ID}`] = firebase.database.ServerValue.increment(1); updates[`/users/${user.uid}/activeDevices`] = firebase.database.ServerValue.increment(1); updates[`/users/${user.uid}/totalHashRate`] = firebase.database.ServerValue.increment(freeMiner.hashRate); updates[`/users/${user.uid}/freeMinerClaimed`] = true; try { await db.ref().update(updates); showToast('Free miner claimed successfully!'); document.getElementById('claim-miner-banner').style.display = 'none'; } catch (error) { showToast('Failed to claim miner: ' + error.message, true); } finally { loadingOverlay.style.display = 'none'; } });
            
            // --- NEW DASHBOARD EVENT LISTENERS ---
            const walletCard = document.querySelector('.wallet-card');
            const switchBtn = document.getElementById('currency-switch-btn');
            const switchBtnBack = document.getElementById('currency-switch-btn-back');
            
            if (preferredCurrencyView === 'BTC') { walletCard.classList.add('flipped'); }

            function handleSwitch() {
                walletCard.classList.toggle('flipped');
                preferredCurrencyView = walletCard.classList.contains('flipped') ? 'BTC' : 'USDT';
                localStorage.setItem('currencyView', preferredCurrencyView);
            }
            switchBtn.addEventListener('click', handleSwitch);
            switchBtnBack.addEventListener('click', handleSwitch);
            
            document.getElementById('new-send-btn').addEventListener('click', openSendFlow);
            document.getElementById('new-send-btn-back').addEventListener('click', openSendFlow);
            document.getElementById('new-receive-btn').addEventListener('click', showReceivePage);
            document.getElementById('new-receive-btn-back').addEventListener('click', showReceivePage);
            document.getElementById('new-fund-btn').addEventListener('click', openFundFlow);
            document.getElementById('new-fund-btn-back').addEventListener('click', openFundFlow);
            document.getElementById('new-history-btn').addEventListener('click', () => showPage('history-page'));
            document.getElementById('new-history-btn-back').addEventListener('click', () => showPage('history-page'));

        });
    </script>
</body>
</html>
